sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,a,o,s,r,n,i){"use strict";var l=r.ButtonType;var d=r.DialogType;var u=i.ValueState;return e.extend("frontend.bbs.controller.advanceEmployee.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("advanceEmployeeDetail").attachPatternMatched(this._onObjectMatched,this);var t=new a(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(t,"items")},_onObjectMatched:async function(e){var t=new a;this.getView().setModel(t,"viewModel");this.getView().byId("advanceRequestPageId").setBusy(true);var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=o.get("jwt");var s=new a;await s.loadData(backendUrl+"checkToken",null,true,"POST",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().bindElement({path:"/value/"+window.decodeURIComponent(e.getParameter("arguments").ID),model:"advanceRequest"});var r=e.getParameter("arguments").ID;if(r===undefined){var n=window.location.href;var i=n.split("/");r=i[i.length-1]}const l=new a;l.loadData(backendUrl+"advanceRequest/getAdvanceRequestById?code="+r,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(l,"advanceRequestDetailModel");var d=new a;d.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(d,"budgeting");l.dataLoaded().then(function(){var e=s.getData();var o=this.getView().getModel("advanceRequestDetailModel").getData();if(e.user.role_id==4){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==3){t.setProperty("/showFooter",false)}}else if(e.user.role_id==5){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==2){t.setProperty("/showFooter",false)}}else if(e.user.role_id==3){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",true);if(o.U_Status!=1){t.setProperty("/showFooter",false);t.setProperty("/editable",false)}}const r=new a;r.loadData(backendUrl+"budget/getBudgetById?code="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(r,"budget");r.dataLoaded().then(function(){var e=r.getData();var t=e.U_TotalAmount;var a=e.BUDGETUSEDCollection;let o=0;for(let e=0;e<a.length;e++){o+=a[e]["U_Amount"]}e.U_RemainingBudget=t-o;var s=this.getView().getModel("budget");s.setData(e);this.getView().byId("advanceRequestPageId").setBusy(false)}.bind(this))}.bind(this))},onAmountChange:function(e){const t=this.getView().getModel("advanceRequestDetailModel");var a=t.getData().ADVANCEREQLINESCollection;console.log(a);let o=0;for(let e=0;e<a.length;e++){o+=a[e]["U_Amount"]}console.log(o);const s=this.getView().getModel("advanceRequestDetailModel");s.setProperty("/U_Amount",o)},onBudgetChange:async function(e){this.getView().byId("createARForm").setBusy(true);var t=parseInt(e.getParameters("selectedItem").value);var o=new a;await o.loadData(backendUrl+"budget/getBudgetById?code="+t,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var s=o.getData();var r=s.U_TotalAmount;var n=s.BUDGETUSEDCollection;let i=0;for(let e=0;e<n.length;e++){i+=n[e]["U_Amount"]}s.U_RemainingBudget=r-i;var l=this.getView().getModel("budget");l.setData(s);this.getView().byId("createARForm").setBusy(false)},onApproveButtonClick:function(){var e=this.getView().byId("advanceRequestPageId");var t=this.getView().getModel("viewModel");var a=this.getView().byId("_IDGenText101").getText();const r=this.getView().getModel("advanceRequestDetailModel");var i=this.getView().getModel("budget").getData();r.setProperty("/budgeting",i);var g=r.getProperty("/");var c=this.getView();var h=this.oDialog;var v=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(g),headers:{Authorization:"Bearer "+v},crossDomain:true,url:backendUrl+"advanceRequest/approveAR",contentType:"application/json",success:function(e,t,a){if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new o({type:d.Message,title:"Success",state:u.Success,content:new n({text:"Advance Request approved"}),beginButton:new s({type:l.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,a){console.log("Got an error response: "+t+a)}})},onNavBack:function(){var e=t.getInstance();var a=e.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{var o=this.getOwnerComponent().getRouter();o.navTo("dashboard",{},true)}}})});