sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library","sap/m/MessageToast"],function(e,t,s,a,o,r,i,n,l){"use strict";var c=r.ButtonType;var u=r.DialogType;var d=n.ValueState;return e.extend("frontend.bbs.controller.advanceEmployee.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("advanceEmployeeDetail").attachPatternMatched(this._onObjectMatched,this);var t=new s(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(t,"items")},_onObjectMatched:async function(e){var t=new s({showFooter:false,editable:false,resubmit:false,is_finance:false});const a=this.getOwnerComponent().getModel("globalModel").getData();this.path="";if(a["AEPath"]!=null||a["AEPath"]!=""){this.path=a["AEPath"]}this.getView().setModel(t,"viewModel");this.getView().byId("advanceRequestPageId").setBusy(true);var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=o.get("jwt");this.company=o.get("company");var r=new s;await r.loadData(backendUrl+"checkToken",null,true,"POST",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().bindElement({path:"/value/"+window.decodeURIComponent(e.getParameter("arguments").ID),model:"advanceRequest"});var i=e.getParameter("arguments").ID;this.advanceRequestCode=i;if(i===undefined){var n=window.location.href;var l=n.split("/");i=l[l.length-1]}const c=new s;c.loadData(backendUrl+"advanceRequest/getAdvanceRequestById",{code:i,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var u=new s;u.setSizeLimit(100);u.loadData(backendUrl+"coa/getCOAsForTransfer",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(u,"transferAccounts");this.getView().setModel(c,"advanceRequestDetailModel");var d=new s;d.setSizeLimit(500);d.loadData(backendUrl+"budget/getApprovedBudget",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(d,"budgeting");c.dataLoaded().then(function(){var e=r.getData();var a=this.getView().getModel("advanceRequestDetailModel").getData();if(e.user.role_id==4){t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(a.U_Status==2){t.setProperty("/showFooter",true)}}else if(e.user.role_id==5){t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(a.U_Status==1){t.setProperty("/showFooter",true)}}else if(e.user.role_id==3){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",true);t.setProperty("/resubmit",false);if(a.U_Status==4){t.setProperty("/resubmit",true)}if(a.U_Status==4||a.U_Status==1){t.setProperty("/showFooter",true);t.setProperty("/editable",true)}}else if(e.user.role_id==2){t.setProperty("/is_finance",true);t.setProperty("/is_approver",false);t.setProperty("/is_requestor",false);if(a.U_Status==3){t.setProperty("/showFooter",true)}}var o=new s;o.loadData(backendUrl+"coa/getCOAsByBudget?",{budgetCode:a.U_BudgetCode,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(o,"accounts");const i=new s;i.loadData(backendUrl+"budget/getBudgetById",{code:a.U_BudgetCode,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(i,"budget");i.dataLoaded().then(function(){var e=i.getData();var t=e.U_TotalAmount;var s=e.BUDGETUSEDCollection;let a=0;if(s.length>0){for(let e=0;e<s.length;e++){a+=s[e]["U_Amount"]}}e.U_RemainingBudget=t-a;var o=this.getView().getModel("budget");o.setData(e);this.getView().byId("advanceRequestPageId").setBusy(false)}.bind(this));var n=this.getView().byId("advanceRequestLineTableID");var l=this.getView().getModel("items");l.setProperty("/data",[]);var c=l.getData();var u=new s;var d=[];for(let e=0;e<a.ADVANCEREQLINESCollection.length;e++){if(!(a.ADVANCEREQLINESCollection[e].U_AccountCode.toString()in d)){d.push(a.ADVANCEREQLINESCollection[e].U_AccountCode)}}var g=[...new Set(d)];for(let e=0;e<g.length;e++){this.getView().byId("advanceRequestPageId").setBusy(true);u.loadData(backendUrl+"items/getItemsByAccount",{accountCode:g[e],company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});u.dataLoaded().then(function(){var t=u.getData();c.data[g[e]]=t;var s=new sap.ui.model.json.JSONModel(c);this.getView().setModel(s,"items");s.refresh();this.getView().byId("advanceRequestPageId").setBusy(false)}.bind(this))}for(let e=0;e<a.ADVANCEREQLINESCollection.length;e++){n.getRows()[e].getCells()[1].setBusy(true);let t=a.ADVANCEREQLINESCollection[e].U_AccountCode.toString();n.getRows()[e].getCells()[1].bindAggregation("items",{path:"items>/data/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});n.getRows()[e].getCells()[1].setBusy(false)}}.bind(this))},onAccountCodeChange:async function(e){var t=e.getSource().getSelectedKey();var a=e.getSource().getParent();a.getCells()[1].setBusy(true);a.getCells()[1].setSelectedKey("");a.getCells()[1].setEnabled(true);a.getCells()[1].setEnabled(true);var o=this.getView().getModel("items");var r=o.getData();if(!(t.toString()in r)){var i=new s;await i.loadData(backendUrl+"items/getItemsByAccount",{accountCode:t,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var n=i.getData();r[t]=n;var l=new sap.ui.model.json.JSONModel(r);this.getView().setModel(l,"items");l.refresh()}a.getCells()[1].bindAggregation("items",{path:"items>/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});a.getCells()[1].setBusy(false)},onAmountChange:function(e){const t=this.getView().getModel("advanceRequestDetailModel");const s=this.getView().getModel("viewModel");var a=this.getView().getModel("budget").getData();var o=t.getData().ADVANCEREQLINESCollection;let r=0;for(let e=0;e<o.length;e++){r+=o[e]["U_Amount"]}const i=this.getView().getModel("advanceRequestDetailModel");i.setProperty("/U_Amount",r);var n=a.U_RemainingBudget;if(r>n){this.getView().byId("advanceAmount").setState(d.Error);this.getView().byId("resubmitButton").setEnabled(false);this.getView().byId("submitButton").setEnabled(false);s.setProperty("/amountExceeded","Advance Amount exceeded Budget!")}else{this.getView().byId("advanceAmount").setState(d.None);this.getView().byId("resubmitButton").setEnabled(true);this.getView().byId("submitButton").setEnabled(true);s.setProperty("/amountExceeded","")}},onBudgetChange:async function(e){this.getView().byId("createARForm").setBusy(true);var t=parseInt(e.getParameters("selectedItem").value);var s=this.getView().getModel("budget");await s.loadData(backendUrl+"budget/getBudgetById",{code:t,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});s.refresh();var a=this.getView().getModel("accounts");a.loadData(backendUrl+"coa/getCOAsByBudget",{budgetCode:t,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});a.refresh();const o=this.getView().getModel("advanceRequestDetailModel");o.setProperty("/U_Amount",0);var r=s.getData();var i=r.U_TotalAmount;var n=r.BUDGETUSEDCollection;let l=0;if(n.length>0){for(let e=0;e<n.length;e++){l+=n[e]["U_Amount"]}}var c=i-l;r.U_RemainingBudget=c;s.setData(r);s.refresh();var u=this.getView().getModel("advanceRequestDetailModel");u.setProperty("/ADVANCEREQLINESCollection",[]);u.refresh();this.onAmountChange();this.getView().byId("createARForm").setBusy(false)},onApproveButtonClick:function(){const e=this.getView().getModel("advanceRequestDetailModel");const t=this.getOwnerComponent().getModel("advanceRequests");var s=this.path;var r=this.getView().byId("advanceRequestPageId");var n=this.getView().getModel("viewModel");r.setBusy(true);var l=this.getView().byId("_IDGenText101").getText();var g=this.getView().getModel("budget").getData();e.setProperty("/budgeting",g);var h=e.getProperty("/");var p=this.getView();var f=this.oDialog;var y=this.oJWT;var v=this.company;$.ajax({type:"POST",data:JSON.stringify({oProperty:h,company:v}),headers:{Authorization:"Bearer "+y},crossDomain:true,url:backendUrl+"advanceRequest/approveAR",contentType:"application/json",success:function(l,g,h){r.setBusy(false);if(t){t.setProperty(s+"/U_Status",l["U_Status"])}e.setData(l);e.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Advance Request approved"}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});n.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(e,t,s){r.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new a({type:u.Message,title:"Error",state:d.Error,content:new i({text:e.responseJSON.msg}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onTransferButtonClick:function(){if(!this.transferAdvanceRequestDialog){this.transferAdvanceRequestDialog=this.loadFragment({name:"frontend.bbs.view.advanceEmployee.Transfer"})}this.transferAdvanceRequestDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},onTransferConfirm:function(){const e=this.getView().getModel("advanceRequestDetailModel");const t=this.getOwnerComponent().getModel("advanceRequests");var s=this.path;var r=this.oJWT;var n=this.getView().byId("DatePickerTransferAt").getValue();e.setProperty("/DisbursedDate",n);var g=this.getView().byId("advanceRequestPageId");var h=this.getView().byId("transferDialog");var p=e.getProperty("/");var f=this.company;var y=this.getView().getModel("viewModel");h.close();g.setBusy(true);$.ajax({type:"POST",data:JSON.stringify({company:f,oProperty:p}),headers:{Authorization:"Bearer "+r},crossDomain:true,url:backendUrl+"advanceRequest/transferAR",contentType:"application/json",success:function(a,o,r){g.setBusy(false);if(t){t.setProperty(s+"/U_Status",a["U_Status"]);t.setProperty(s+"/U_DisbursedAt",a["U_DisbursedAt"])}e.setData(a);e.refresh();l.show("Advance Transfered");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});y.setProperty("/showFooter",false)},error:function(e,t,s){g.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new a({type:u.Message,title:"Error",state:d.Error,content:new i({text:e.responseJSON.msg}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var a=this.getOwnerComponent().getRouter();a.navTo("dashboard",{},true)}},onAddPress:function(e){const t=this.getView().getModel("advanceRequestDetailModel");var s=t.getData();var a={U_AccountCode:"",U_ItemCode:"",U_Amount:""};s.ADVANCEREQLINESCollection.push(a);var o=new sap.ui.model.json.JSONModel(s);this.getView().setModel(o,"advanceRequestDetailModel");o.refresh()},onDelete:function(e){var t=e.getParameters().row;var s=t.getIndex();var a=this.getView().getModel("advanceRequestDetailModel");var o=a.getData().ADVANCEREQLINESCollection;o.splice(s,1);a.setProperty("/ADVANCEREQLINESCollection",o);a.refresh();this.onAmountChange()},onSaveButtonClick:function(e){var t=this.getView().byId("advanceRequestPageId");t.setBusy(true);var s=this.getView().getModel("advanceRequestDetailModel");var r=JSON.stringify({data:s.getData(),company:this.company});var n=this.oJWT;var l=this.company;$.ajax({type:"POST",data:r,headers:{Authorization:"Bearer "+n},crossDomain:true,url:backendUrl+"advanceRequest/saveAR",contentType:"application/json",success:function(e,s,r){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Advance Request saved"}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,s,r){t.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new a({type:u.Message,title:"Error",state:d.Error,content:new i({text:e.responseJSON.msg}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onRejectButtonClick:function(e){if(!this.rejectAdvanceRequestDialog){this.rejectAdvanceRequestDialog=this.loadFragment({name:"frontend.bbs.view.advanceEmployee.RejectForm"})}this.rejectAdvanceRequestDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},onConfirmRejectClick:function(){const e=this.getView().getModel("advanceRequestDetailModel");const t=this.getOwnerComponent().getModel("advanceRequests");var s=this.path;var r=this.getView().byId("advanceRequestPageId");var n=this.getView().getModel("advanceRequestDetailModel").getData();r.setBusy(true);var l=this.getView().byId("rejectDialog");var g=n.Code;var h=this.getView().byId("RejectionRemarksID").getValue();var p=this.getView().getModel("viewModel");var f=this.company;$.ajax({type:"POST",data:{Code:g,Remarks:h,company:f},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"advanceRequest/rejectAR",success:function(n,g,h){l.close();r.setBusy(false);if(t){t.setProperty(s+"/U_Status",n["U_Status"])}e.setData(n);e.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Advance Request rejected"}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){p.setProperty("/showFooter",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()}.bind(this),error:function(e,t,s){r.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new a({type:u.Message,title:"Error",state:d.Error,content:new i({text:e.responseJSON.msg}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onResubmitButtonClick:function(e){const t=this.getView().getModel("advanceRequestDetailModel");const s=this.getOwnerComponent().getModel("advanceRequests");var r=this.path;var n=this.getView().byId("advanceRequestPageId");n.setBusy(true);var l=JSON.stringify({company:this.company,data:t.getData()});var g=this.oJWT;var h=this.getView().getModel("viewModel");$.ajax({type:"POST",data:l,headers:{Authorization:"Bearer "+g},crossDomain:true,url:backendUrl+"advanceRequest/resubmitAR",contentType:"application/json",success:function(e,l,g){n.setBusy(false);n.setBusy(false);if(s){s.setProperty(r+"/U_Status",e["U_Status"])}t.setData(e);t.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Advance Request resubmitted"}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){h.setProperty("/showFooter",false);h.setProperty("/editable",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){n.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new a({type:u.Message,title:"Error",state:d.Error,content:new i({text:e.responseJSON.msg}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},handlePrintButtonPressed:function(e){var t=this.getView().byId("advanceRequestPageId");t.setBusy(true);var s=this.oJWT;$.ajax({type:"POST",data:JSON.stringify({company:this.company,code:this.advanceRequestCode}),headers:{Authorization:"Bearer "+s},crossDomain:true,url:backendUrl+"advanceRequest/printAR",contentType:"application/json",responseType:"arraybuffer",success:function(e,s,a){t.setBusy(false);var o=atob(e);var r=new Array(o.length);for(var i=0;i<o.length;i++){r[i]=o.charCodeAt(i)}var n=new Uint8Array(r);var l=new Blob([n],{type:"application/pdf;base64"});var c=URL.createObjectURL(l);window.open(c)},error:function(e,s,r){t.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new a({type:u.Message,title:"Error",state:d.Error,content:new i({text:e.responseJSON.msg}),beginButton:new o({type:c.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else if(e==5){return"Information"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else if(e==5){return"Transferred"}else{return"Rejected"}}})});