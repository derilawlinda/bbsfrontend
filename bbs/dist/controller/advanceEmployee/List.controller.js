sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/core/Fragment","sap/ui/layout/HorizontalLayout","sap/ui/layout/VerticalLayout","sap/m/Dialog","sap/m/Button","sap/m/Label","sap/m/library","sap/m/MessageToast","sap/m/Text","sap/m/TextArea","sap/ui/model/json/JSONModel"],function(e,t,o,a,s,n,r,i,l,u,d,g,c){"use strict";var h=l.ButtonType;var v=l.DialogType;return e.extend("frontend.bbs.controller.advanceEmployee.List",{onInit:function(){this.getView().byId("advanceEmployeeTableID").setBusy(true);var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");var o=new c;o.loadData(backendUrl+"advanceRequest/getAdvanceRequests",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(o,"advanceRequests");o.dataLoaded().then(function(){this.getView().byId("advanceEmployeeTableID").setBusy(false)}.bind(this));var a=new c(sap.ui.require.toUrl("frontend/bbs/model/sales_order.json"));this.getView().setModel(a,"salesOrder");var s=new c(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(s,"companies");var n=new c(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(n,"items");var r=new sap.ui.model.json.JSONModel;var i=new sap.ui.model.json.JSONModel({showCreateButton:true});this.getView().setModel(i,"viewModel");this.getView().setModel(r,"advanceRequestHeader");var l=new sap.ui.model.json.JSONModel({U_RemainingBudget:0});this.getView().setModel(l,"budgetHeader");var u=new c;u.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(u,"budgeting");var d=new sap.ui.model.json.JSONModel;this.getView().setModel(d,"new_ar_items");this.getView().getModel("new_ar_items").setProperty("/ADVANCEREQLINESCollection",[]);var g=this.getOwnerComponent().getModel("userModel");if(g===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.toggleCreateButton,this)}else{var h=g.getData();var v={userName:h.user.name,roleId:h.user.role_id,roleName:h.role[0].name,status:"success"};this.toggleCreateButton("username","checkToken",v)}},toggleCreateButton:function(e,t,o){console.log(o);if(o.roleId==4||o.roleId==5){this.getView().getModel("viewModel").setProperty("/showCreateButton",false)}},onCreateButtonClick:function(e){if(!this.createEmployeeAdvanceDialog){this.createEmployeeAdvanceDialog=this.loadFragment({name:"frontend.bbs.view.advanceEmployee.CreateForm"})}this.createEmployeeAdvanceDialog.then(function(e){var t=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(t,"createFragmentViewModel");var o=this.getView().getModel("budgetHeader");o.setData([]);var a=new sap.ui.model.json.JSONModel;this.getView().setModel(a,"advanceRequestHeader");var s=new sap.ui.model.json.JSONModel;this.getView().setModel(s,"new_ar_items");this.getView().getModel("new_ar_items").setProperty("/ADVANCEREQLINESCollection",[]);this.oDialog=e;this.oDialog.open()}.bind(this))},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},onNavBack:function(e){var o,a;o=t.getInstance();a=o.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},_closeDialog:function(){this.oDialog.close()},buttonFormatter:function(e){if(e==2||e==3){return"Accept"}else if(e==1){return"Attention"}else{return"Reject"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},dateFormatter:function(e){var t=new Date(e);var o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var a=o.format(t);return a},onBudgetChange:async function(e){this.getView().byId("createARForm").setBusy(true);var t=parseInt(e.getParameters("selectedItem").value);var o=new c;await o.loadData(backendUrl+"budget/getBudgetById?code="+t,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var a=o.getData();var s=a.U_TotalAmount;var n=a.BUDGETUSEDCollection;let r=0;for(let e=0;e<n.length;e++){r+=n[e]["U_Amount"]}a.U_RemainingBudget=s-r;var i=this.getView().getModel("budgetHeader");i.setData(a);this.getView().byId("createARForm").setBusy(false)},onPress:function(e){var t=this.getOwnerComponent().getRouter();var o=e.getSource();var a=o.getCells()[0].getText();t.navTo("advanceEmployeeDetail",{ID:a})},onAddPress:function(e){const t=this.getView().getModel("new_ar_items");var o=t.getData();var a={U_AccountCode:"",U_ItemCode:"",U_Amount:""};o.ADVANCEREQLINESCollection.push(a);var s=new sap.ui.model.json.JSONModel(o);this.getView().setModel(s,"new_ar_items");s.refresh()},onSaveButtonClick:function(e){var t=this.oDialog;t.setBusy(true);var o=this.getView().getModel("advanceRequests");const a=this.getView().getModel("advanceRequestHeader");const s=this.getView().getModel("new_ar_items");a.setProperty("/ADVANCEREQLINESCollection",s.getData().ADVANCEREQLINESCollection);var n=a.getProperty("/");var r=this.getView();var i=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(n),crossDomain:true,headers:{Authorization:"Bearer "+i},url:backendUrl+"advanceRequest/createAdvanceRequest",contentType:"application/json",success:function(e,a,s){t.setBusy(false);t.close();o.loadData(backendUrl+"advanceRequest/getAdvanceRequests",null,true,"GET",false,false,{Authorization:"Bearer "+i});u.show("Advance Request created");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});r.getModel("advanceRequests").refresh()},error:function(e,t,o){console.log("Got an error response: "+t+o)}})},onAmountChange:function(e){const t=this.getView().getModel("new_ar_items");var o=t.getData().ADVANCEREQLINESCollection;console.log(o);let a=0;for(let e=0;e<o.length;e++){a+=o[e]["U_Amount"]}console.log(a);const s=this.getView().getModel("advanceRequestHeader");s.setProperty("/U_Amount",a)}})});