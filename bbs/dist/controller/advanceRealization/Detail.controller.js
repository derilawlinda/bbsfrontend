sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library","sap/m/MessageToast"],function(e,t,a,s,o,i,r,n,l){"use strict";var u=i.ButtonType;var c=i.DialogType;var d=n.ValueState;return e.extend("frontend.bbs.controller.advanceRealization.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("advanceRealizationDetail").attachPatternMatched(this._onObjectMatched,this);var t=new a;this.getView().setModel(t,"items")},_onObjectMatched:async function(e){var t=new a({showFooter:false,editable:true,resubmit:false,is_finance:false,is_save:false,is_approver:false,is_submit:false,NPWP:[{Name:0},{Name:2.5},{Name:3}]});this.path="";var s=this.getOwnerComponent().getModel("globalModel").getData();if(s["RealizationPath"]!=null||s["RealizationPath"]!=""){this.path=s["RealizationPath"]}console.log(this.path);this.getView().setModel(t,"viewModel");this.getView().byId("advanceRequestPageId").setBusy(true);var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=o.get("jwt");this.company=o.get("company");var i=new a;await i.loadData(backendUrl+"checkToken",null,true,"POST",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().bindElement({path:"/value/"+window.decodeURIComponent(e.getParameter("arguments").ID),model:"advanceRequest"});var r=e.getParameter("arguments").ID;this.advanceRequestCode=r;if(r===undefined){var n=window.location.href;var l=n.split("/");r=l[l.length-1]}const u=new a;u.loadData(backendUrl+"advanceRequest/getAdvanceRequestById",{code:r,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var c=new a;c.loadData(backendUrl+"coa/getCOAsForTransfer",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(c,"transferAccounts");this.getView().setModel(u,"advanceRequestDetailModel");var d=this.getView().byId("advanceRealLineTableID");u.dataLoaded().then(function(){var e=i.getData();var s=this.getView().getModel("advanceRequestDetailModel").getData();var o=this.oJWT;this.onAmountChange();if(e.user.role_id==4){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(s.U_RealiStatus==3){t.setProperty("/showFooter",true)}}else if(e.user.role_id==5){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(s.U_RealiStatus==2){t.setProperty("/showFooter",true)}}else if(e.user.role_id==3){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",true);if(s.U_RealiStatus==1){t.setProperty("/is_save",false);t.setProperty("/is_submit",true);t.setProperty("/showFooter",true)}if(s.U_RealiStatus==2){t.setProperty("/is_save",true);t.setProperty("/is_submit",false);t.setProperty("/showFooter",true);t.setProperty("/editable",true)}if(s.U_RealiStatus==5){console.log(s.U_RealiStatus);t.setProperty("/editable",true);t.setProperty("/is_save",false);t.setProperty("/resubmit",true);t.setProperty("/showFooter",true)}}else if(e.user.role_id==2){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",false);t.setProperty("/is_finance",true);t.setProperty("/editable",false);if(s.U_RealiStatus==4){t.setProperty("/showFooter",true)}}const r=new a;r.loadData(backendUrl+"budget/getBudgetById",{code:s.U_BudgetCode,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(r,"budget");r.dataLoaded().then(function(){var e=r.getData();var t=e.U_TotalAmount;var a=e.BUDGETUSEDCollection;let s=0;if(a.length>0){for(let e=0;e<a.length;e++){s+=a[e]["U_Amount"]}}var o=this.getView().getModel("budget");o.setProperty("/U_RemainingBudget",t-s);this.getView().byId("advanceRequestPageId").setBusy(false)}.bind(this));var n=new a;n.loadData(backendUrl+"coa/getCOAsByAR",{ARCode:s.Code,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+o});this.getView().setModel(n,"accounts");n.dataLoaded().then(function(){var e=this.getView().getModel("items");e.setProperty("/data/",[]);e.refresh();var t=new a;var i=s.REALIZATIONREQLINESCollection;for(let a=0;a<i.length;a++){d.getRows()[a].getCells()[1].setBusy(true);var r=e.getData();let s=i[a].U_AccountCode.toString();if(!(i[a].U_AccountCode in r)){t.loadData(backendUrl+"items/getItemsByAccount",{accountCode:s,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+o});t.dataLoaded().then(function(){var e=t.getData();var o=this.getView().getModel("items");o.setProperty("/data/"+s,e);o.refresh();d.getRows()[a].getCells()[1].bindAggregation("items",{path:"items>/data/"+s,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});d.getRows()[a].getCells()[1].setBusy(false)}.bind(this))}else{d.getRows()[a].getCells()[1].bindAggregation("items",{path:"items>/data/"+s,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});d.getRows()[a].getCells()[1].setBusy(false)}}}.bind(this));this.getView().byId("advanceRequestPageId").setBusy(false)}.bind(this))},onSubmitButtonClick:function(e){const t=this.getView().getModel("advanceRequestDetailModel");var a=t.getProperty("/");var i=this.getView().getModel("viewModel");t.setProperty("/U_DifferenceAmt",a.U_Amount-a.U_RealizationAmt);if(a.U_RealizationAmt<a.U_Amount){if(!this.transferAdvanceRequestDialog){this.transferAdvanceRequestDialog=this.loadFragment({name:"frontend.bbs.view.advanceRealization.Transfer"})}this.transferAdvanceRequestDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))}else{if(!this.oTransferConfirmationMessageDialog){this.oTransferConfirmationMessageDialog=new s({type:c.Message,title:"Confirmation",state:d.Attention,content:new r({text:"Realized Amount equals to the advance amount.  Continue ?"}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.submitAdvanceRealization();i.setProperty("/resubmit",false);i.setProperty("/is_submit",false);i.setProperty("/is_save",true);this.oTransferConfirmationMessageDialog.close()}.bind(this)}),endButton:new o({type:u.Default,text:"Cancel",press:function(){this.oTransferConfirmationMessageDialog.close()}.bind(this)})})}this.oTransferConfirmationMessageDialog.open()}},onConfirmButtonClick:function(){const e=this.getView().getModel("advanceRequestDetailModel");var t=this.getView().byId("advanceRequestPageId");var a=this.getView();var i=e.getProperty("/");var n=this.oJWT;var g=this.company;const h=this.getOwnerComponent().getModel("advanceRealization");var p=this.path;t.setBusy(true);$.ajax({type:"POST",data:JSON.stringify({oProperty:i,company:g}),crossDomain:true,headers:{Authorization:"Bearer "+n},url:backendUrl+"advanceRequest/confirmAdvanceRealization",contentType:"application/json",success:function(s,o,i){t.setBusy(false);if(h){h.setProperty(p+"/U_RealiStatus",s["U_RealiStatus"])}e.setData(s);e.refresh();l.show("Advance Realization confimed");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});a.getModel("advanceRequestDetailModel").refresh()},error:function(e,a,i){t.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new s({type:c.Message,title:"Error",state:d.Error,content:new r({text:e.responseJSON.msg}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},submitAdvanceRealization:function(){const e=this.getView().getModel("advanceRequestDetailModel");const t=this.getOwnerComponent().getModel("advanceRealization");var a=this.getView().byId("advanceRequestPageId");var i=this.path;var n=this.getView();var g=this.getView().byId("advanceRequestPageId");var h=this.getView().byId("transferDialogID");var p=e.getProperty("/");if(p.U_RealizationAmt<p.U_Amount){e.setProperty("/U_RealTrfBank",n.byId("transferTo").getSelectedKey())}var f=this.oJWT;var y=this.company;var m=this.getView().getModel("viewModel");a.setBusy(true);$.ajax({type:"POST",data:JSON.stringify({oProperty:p,company:y}),crossDomain:true,headers:{Authorization:"Bearer "+f},url:backendUrl+"advanceRequest/submitAdvanceRealization",contentType:"application/json",success:function(a,s,o){g.setBusy(false);if(t){t.setProperty(i+"/U_RealiStatus",a["U_RealiStatus"])}e.setData(a);e.refresh();l.show("Advance Realization Submitted");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});n.getModel("advanceRequestDetailModel").refresh();m.setProperty("/resubmit",false);m.setProperty("/is_submit",false);m.setProperty("/is_save",true);if(h){h.close()}},error:function(e,t,a){g.setBusy(false);if(h){h.close()}if(!this.oErrorDialog){this.oErrorDialog=new s({type:c.Message,title:"Error",state:d.Error,content:new r({text:e.responseJSON.msg}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onRejectButtonClick:function(e){if(!this.rejectAdvanceRealizationDialog){this.rejectAdvanceRealizationDialog=this.loadFragment({name:"frontend.bbs.view.advanceRealization.RejectForm"})}this.rejectAdvanceRealizationDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},onConfirmRejectClick:function(){var e=this.getView().byId("advanceRequestPageId");var t=this.getView().getModel("advanceRequestDetailModel").getData();e.setBusy(true);var a=this.getView().byId("rejectDialog");var i=t.Code;var n=this.getView().byId("RejectionRemarksID").getValue();var l=this.getView().getModel("viewModel");const g=this.getView().getModel("advanceRequestDetailModel");const h=this.getOwnerComponent().getModel("advanceRealization");var p=this.path;$.ajax({type:"POST",data:{Code:i,Remarks:n,company:this.company},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"advanceRequest/rejectAdvanceRealization",success:function(t,i,n){a.close();e.setBusy(false);if(h){h.setProperty(p+"/U_RealiStatus",t["U_RealiStatus"])}g.setData(t);g.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new s({type:c.Message,title:"Success",state:d.Success,content:new r({text:"Advance Realization rejected"}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){l.setProperty("/showFooter",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()}.bind(this),error:function(t,a,i){e.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new s({type:c.Message,title:"Error",state:d.Error,content:new r({text:t.responseJSON.msg}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onAccountCodeChange:async function(e){var t=e.getSource().getSelectedKey();var s=e.getSource().getParent();s.getCells()[1].setBusy(true);s.getCells()[1].setSelectedKey("");s.getCells()[1].setEnabled(true);s.getCells()[1].setEnabled(true);var o=this.getView().getModel("items");var i=o.getData();if(!(t.toString()in i)){var r=new a;await r.loadData(backendUrl+"items/getItemsByAccount",{accountCode:t,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var n=r.getData();i[t]=n;var l=new sap.ui.model.json.JSONModel(i);this.getView().setModel(l,"items");l.refresh()}s.getCells()[1].bindAggregation("items",{path:"items>/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});s.getCells()[1].setBusy(false)},onAmountChange:function(e){const t=this.getView().getModel("advanceRequestDetailModel");const a=t.getData();const s=a.U_Amount;var o=t.getData().REALIZATIONREQLINESCollection;var i=this.getView().getModel("viewModel");let r=0;if(o.length>0){for(let e=0;e<o.length;e++){r+=Number(o[e]["U_Amount"])}}const n=this.getView().getModel("advanceRequestDetailModel");n.setProperty("/U_RealizationAmt",r);n.setProperty("/U_DifferenceAmt",s-r);if(r>s){this.getView().byId("realizationAmount").setState(d.Error);i.setProperty("/amountExceeded","Realization Amount exceeded Advance Amount");this.getView().byId("submitButton").setEnabled(false);this.getView().byId("saveButton").setEnabled(false)}else{this.getView().byId("realizationAmount").setState(d.None);i.setProperty("/amountExceeded","");this.getView().byId("submitButton").setEnabled(true);this.getView().byId("saveButton").setEnabled(true)}},onBudgetChange:async function(e){this.getView().byId("createARForm").setBusy(true);var t=parseInt(e.getParameters("selectedItem").value);var s=new a;await s.loadData(backendUrl+"budget/getBudgetById",{code:t,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var o=s.getData();var i=o.U_TotalAmount;var r=o.BUDGETUSEDCollection;let n=0;for(let e=0;e<r.length;e++){n+=r[e]["U_Amount"]}o.U_RemainingBudget=i-n;var l=this.getView().getModel("budget");l.setData(o);this.getView().byId("createARForm").setBusy(false)},onSaveButtonClick:function(e){var t=this.getView().byId("advanceRequestPageId");t.setBusy(true);var a=this.getView().getModel("advanceRequestDetailModel");var i=JSON.stringify({company:this.company,data:a.getData()});var n=this.oJWT;$.ajax({type:"POST",data:i,headers:{Authorization:"Bearer "+n},crossDomain:true,url:backendUrl+"advanceRequest/saveAR",contentType:"application/json",success:function(e,a,i){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new s({type:c.Message,title:"Success",state:d.Success,content:new r({text:"Advance Realization saved"}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,a,i){t.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new s({type:c.Message,title:"Error",state:d.Error,content:new r({text:e.responseJSON.msg}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onApproveButtonClick:function(){var e=this.getView().byId("advanceRequestPageId");var t=this.getView().getModel("viewModel");e.setBusy(true);var a=this.getView().byId("advanceRequestId").getText();const i=this.getView().getModel("advanceRequestDetailModel");const n=this.getOwnerComponent().getModel("advanceRealization");var l=this.path;var g=i.getData();var a=g.Code;var h=this.oJWT;$.ajax({type:"POST",data:{Code:a,company:this.company},headers:{Authorization:"Bearer "+h},crossDomain:true,url:backendUrl+"advanceRequest/approveAdvanceRealization",success:function(a,g,h){e.setBusy(false);if(n){n.setProperty(l+"/U_RealiStatus",a["U_RealiStatus"])}i.setData(a);i.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new s({type:c.Message,title:"Success",state:d.Success,content:new r({text:"Realization approved"}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});t.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(t,a,i){e.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new s({type:c.Message,title:"Error",state:d.Error,content:new r({text:t.responseJSON.msg}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},handlePrintButtonPressed:function(e){var t=this.getView().byId("advanceRequestPageId");t.setBusy(true);var a=this.oJWT;$.ajax({type:"POST",data:JSON.stringify({company:this.company,code:this.advanceRequestCode}),headers:{Authorization:"Bearer "+a},crossDomain:true,url:backendUrl+"advanceRequest/printRealization",contentType:"application/json",responseType:"arraybuffer",success:function(e,a,s){t.setBusy(false);var o=atob(e);var i=new Array(o.length);for(var r=0;r<o.length;r++){i[r]=o.charCodeAt(r)}var n=new Uint8Array(i);var l=new Blob([n],{type:"application/pdf;base64"});var u=URL.createObjectURL(l);window.open(u)},error:function(e,a,i){t.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new s({type:c.Message,title:"Error",state:d.Error,content:new r({text:e.responseJSON.msg}),beginButton:new o({type:u.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})},onAddPress:function(e){const t=this.getView().getModel("advanceRequestDetailModel");var a=t.getData();var s={U_AccountCode:"",U_ItemCode:"",U_NPWP:"",U_Amount:0,U_Description:""};a.REALIZATIONREQLINESCollection.push(s);var o=new sap.ui.model.json.JSONModel(a);this.getView().setModel(o,"advanceRequestDetailModel");o.refresh()},onDelete:function(e){var t=e.getParameters().row;var a=t.getIndex();var s=this.getView().getModel("advanceRequestDetailModel");var o=s.getData().REALIZATIONREQLINESCollection;o.splice(a,1);s.setProperty("/REALIZATIONREQLINESCollection",o);s.refresh();this.onAmountChange()},onNavBack:function(){var e=t.getInstance();var a=e.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{var s=this.getOwnerComponent().getRouter();s.navTo("dashboard",{},true)}},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else if(e==5){return"Information"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else if(e==5){return"Transferred"}else{return"Rejected"}},realizationButtonFormatter:function(e){if(e==3||e==4){return"Success"}else if(e==1||e==2){return"Warning"}else{return"Error"}},realizationObjectFormatter:function(e){if(e==1){return"Information"}else if(e==2){return"Warning"}else if(e==3){return"Success"}else if(e==4){return"Information"}else if(e==6){return"Success"}else{return"Error"}},relizationTextFormatter:function(e){if(e==1){return"Unrealized"}else if(e==2){return"Submitted"}else if(e==3){return"Approved by Manager"}else if(e==4){return"Approved by Director"}else if(e==6){return"Realized"}else{return"Rejected"}}})});