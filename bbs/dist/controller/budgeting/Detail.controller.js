sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library","sap/m/Input","sap/m/TextArea"],function(e,t,s,i,a,o,n,r,l,g){"use strict";var c=o.ButtonType;var u=o.DialogType;var d=r.ValueState;return e.extend("frontend.bbs.controller.budgeting.Detail",{onInit:async function(){this.currentRoute=this.getOwnerComponent().getRouter().getHashChanger().getHash();this.oStore=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=this.oStore.get("jwt");this.company=this.oStore.get("company");var e=this.getOwnerComponent();var t=new s(sap.ui.require.toUrl("frontend/bbs/model/sales_order.json"));this.getView().setModel(t,"salesOrder");this.oRouter=e.getRouter();this.userModel=e.getModel("userModel");this.getView().setModel(this.userModel,"userModel");this.oRouter.getRoute("budgetingDetail").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=new s({showFooter:false,editable:false,resubmit:false,is_approver:false,is_requestor:false});this.getView().setModel(t,"viewModel");this.getView().byId("budgetingPageId").setBusy(true);this.budgetCode=e.getParameter("arguments").budgetID;var i=this.getOwnerComponent().getModel("userModel");if(i===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.buildForm,this)}else{var a=i.getData();var o={userName:a.user.name,roleId:a.user.role_id,roleName:a.role[0].name,status:"success"};this.buildForm("username","checkToken",o)}},buildForm:function(e,t,i){var a=this.company;if(i.status=="error"){alert("Error");this.getView().byId("budgetingPageId").setBusy(false)}var o=this.budgetCode;var n=this.getView().getModel("viewModel");var r=new s;r.setSizeLimit(1e3);r.loadData(backendUrl+"coa/getCOAs",{company:a},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(r,"accounts");if(o===undefined){var l=window.location.href;var g=l.split("/");o=g[g.length-1]}const c=new s;c.loadData(backendUrl+"budget/getBudgetById?code="+o,{company:a},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var u=new s;u.loadData(backendUrl+"project/getProjects",{company:a},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(u,"projects");this.getView().setModel(c,"budgetingDetailModel");c.dataLoaded().then(function(){var e=c.getData();if(i.roleId==4){n.setProperty("/editable",false);n.setProperty("/is_approver",true);if(e.U_Status==2){n.setProperty("/showFooter",true)}}else if(i.roleId==5){n.setProperty("/editable",false);n.setProperty("/is_approver",true);if(e.U_Status==1){n.setProperty("/showFooter",true)}}else if(i.roleId==3){n.setProperty("/is_requestor",true);n.setProperty("/resubmit",false);if(e.U_Status==4){n.setProperty("/resubmit",true)}if(e.U_Status==4||e.U_Status==1){n.setProperty("/showFooter",true);n.setProperty("/editable",true)}}else if(i.roleId==2){n.setProperty("/editable",true);n.setProperty("/showFooter",true);n.setProperty("/is_requestor",true)}var t=this.getView().byId("company").getSelectedItem().getBindingContext("companies").getPath();console.log(t);this.getView().byId("CreatePillar").bindAggregation("items",{path:"companies>"+t+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})});this.getView().byId("CreatePillar").setSelectedKey(e.U_Pillar);var s=this.getView().byId("CreatePillar").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreateClassification").bindAggregation("items",{path:"companies>"+s+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})});this.getView().byId("CreateClassification").setSelectedKey(e.U_Classification);var a=this.getView().byId("CreateClassification").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreateSubClassification").bindAggregation("items",{path:"companies>"+a+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})});this.getView().byId("CreateSubClassification").setSelectedKey(e.U_SubClass);var o=this.getView().byId("CreateSubClassification").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreateSubClassification2").bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})});this.getView().byId("CreateSubClassification2").setSelectedKey(e.U_SubClass2);this.getView().byId("budgetingPageId").setBusy(false);var r=e.BUDGETUSEDCollection;let l=0;if(r.length>0){for(let e=0;e<r.length;e++){l+=Number(r[e]["U_Amount"])}}c.setProperty("/U_TotalUsedBudget",Number(l));var g=Number(e.U_TotalAmount-l);c.setProperty("/U_RemainingBudget",Number(g))}.bind(this))},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var i=this.getOwnerComponent().getRouter();i.navTo("dashboard",{},true)}},onApproveButtonClick:function(e){var t=this.getView().byId("budgetingPageId");var s=this.getView().getModel("viewModel");t.setBusy(true);var o=this.getView().byId("_IDGenText101").getText();$.ajax({type:"POST",data:{Code:o,company:this.company},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"budget/approveBudget",success:function(e,o,r){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new i({type:u.Message,title:"Success",state:d.Success,content:new n({text:"Budget approved"}),beginButton:new a({type:c.Emphasized,text:"OK",press:function(){s.setProperty("/showFooter",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onRejectButtonClick:function(e){if(!this.rejectBudgetingDialog){this.rejectBudgetingDialog=this.loadFragment({name:"frontend.bbs.view.budgeting.RejectForm"})}this.rejectBudgetingDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},onConfirmRejectClick:function(){var e=this.getView().byId("budgetingPageId");var t=this.getView().getModel("budgetingDetailModel").getData();e.setBusy(true);var s=t.Code;var o=t.U_Company;var r=this.getView().byId("RejectionRemarksID").getValue();var l=this.getView().byId("rejectDialog");var g=this.getView().getModel("viewModel");$.ajax({type:"POST",data:{Code:s,Remarks:r,Company:o},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"budget/rejectBudget",success:function(t,s,o){l.close();e.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new i({type:u.Message,title:"Success",state:d.Success,content:new n({text:"Budget rejected"}),beginButton:new a({type:c.Emphasized,text:"OK",press:function(){g.setProperty("/showFooter",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()}.bind(this),error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onAmountChange:function(e){const t=this.getView().getModel("budgetingDetailModel");var s=t.getData();var i=t.getData().BUDGETREQLINESCollection;let a=0;for(let e=0;e<i.length;e++){a+=Number(i[e]["U_Amount"])}t.setProperty("/U_TotalAmount",a);var o=s.BUDGETUSEDCollection;let n=0;if(o.length>0){for(let e=0;e<o.length;e++){n+=Number(o[e]["U_Amount"])}}t.setProperty("/U_TotalUsedBudget",Number(n));var r=Number(s.U_TotalAmount)-Number(n);t.setProperty("/U_RemainingBudget",Number(r))},onCompanyChange:function(e){this.getView().byId("CreatePillar").setSelectedKey("");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateClassification").setEnabled(false);this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);console.log(s);console.log(i);var t=e.getSource(),s=t.getSelectedKey(),i=t.getValue();if(!s&&i){t.setValueState(d.Error);t.setValueStateText("Please enter a valid Company");this.getView().byId("CreatePillar").setEnabled(false)}else{t.setValueState(d.None);var a=e.oSource.getSelectedItem().getBindingContext("companies").getPath();this.companyPath=a;var o=this.getView().byId("CreatePillar");o.setEnabled(true);o.bindAggregation("items",{path:"companies>"+a+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})})}},onPillarChange:function(e){this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var t=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var s=this.getView().byId("CreateClassification");s.setEnabled(true);s.bindAggregation("items",{path:"companies>"+t+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})})},onClassificationChange:function(e){this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification2").setEnabled(false);var t=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var s=this.getView().byId("CreateSubClassification");s.setEnabled(true);s.bindAggregation("items",{path:"companies>"+t+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})})},onSubClassificationChange:function(e){this.getView().byId("CreateSubClassification2").setSelectedKey("");var t=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var s=this.getView().byId("CreateSubClassification2");s.setEnabled(true);s.bindAggregation("items",{path:"companies>"+t+"/nodes",template:new sap.ui.core.Item({key:"{companies>text}",text:"{companies>text}"})})},onAddPress:function(e){const t=this.getView().getModel("budgetingDetailModel");var s=t.getData();var i={U_AccountCode:"",U_Amount:""};s.BUDGETREQLINESCollection.push(i);var a=new sap.ui.model.json.JSONModel(s);this.getView().setModel(a,"budgetingDetailModel");a.refresh()},onSaveButtonClick:function(e){var t=this.getView().byId("budgetingPageId");t.setBusy(true);var s=this.getView().getModel("budgetingDetailModel");var o=JSON.stringify(s.getData());var r=this.oJWT;$.ajax({type:"POST",data:o,headers:{Authorization:"Bearer "+r},crossDomain:true,url:backendUrl+"budget/saveBudget",contentType:"application/json",success:function(e,s,o){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new i({type:u.Message,title:"Success",state:d.Success,content:new n({text:"Budget saved"}),beginButton:new a({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onResubmitButtonClick:function(e){var t=this.getView().byId("budgetingPageId");t.setBusy(true);var s=this.getView().getModel("budgetingDetailModel");var o=JSON.stringify(s.getData());var r=this.oJWT;$.ajax({type:"POST",data:o,headers:{Authorization:"Bearer "+r},crossDomain:true,url:backendUrl+"budget/resubmitBudget",contentType:"application/json",success:function(e,s,o){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new i({type:u.Message,title:"Success",state:d.Success,content:new n({text:"Budget resubmitted"}),beginButton:new a({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onDelete:function(e){var t=e.getParameters().row;var s=t.getIndex();var i=this.getView().getModel("budgetingDetailModel");var a=i.getData().BUDGETREQLINESCollection;a.splice(s,1);i.setProperty("/BUDGETREQLINESCollection",a);i.refresh();this.onAmountChange()},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}}})});