sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,s,o,r,i,a,n){"use strict";var u=i.ButtonType;var d=i.DialogType;var l=n.ValueState;return e.extend("frontend.bbs.controller.budgeting.Detail",{onInit:async function(){this.currentRoute=this.getOwnerComponent().getRouter().getHashChanger().getHash();this.oStore=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=this.oStore.get("jwt");var e=this.getOwnerComponent();var t=new s(sap.ui.require.toUrl("frontend/bbs/model/sales_order.json"));this.getView().setModel(t,"salesOrder");this.oRouter=e.getRouter();this.userModel=e.getModel("userModel");this.viewModel=new s;this.getView().setModel(this.viewModel,"viewModel");this.getView().setModel(this.userModel,"userModel");this.oRouter.getRoute("budgetingDetail").attachPatternMatched(this._onObjectMatched,this);var o=new s(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(o,"companies")},_onObjectMatched:function(e){var t=new s;this.getView().setModel(t,"viewModel");this.getView().byId("budgetingPageId").setBusy(true);this.budgetCode=e.getParameter("arguments").budgetID;var o=this.getOwnerComponent().getModel("userModel");if(o===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.buildForm,this)}else{var r=o.getData();var i={userName:r.user.name,roleId:r.user.role_id,roleName:r.role[0].name,status:"success"};this.buildForm("username","checkToken",i)}},buildForm:function(e,t,o){if(o.status=="error"){alert("Error");this.getView().byId("budgetingPageId").setBusy(false)}var r=this.budgetCode;var i=this.getView().getModel("viewModel");if(o.roleId==3){i.setProperty("/editable",true)}else{i.setProperty("/editable",false)}if(o.roleId==4||o.roleId==5){i.setProperty("/is_approver",true);i.setProperty("/is_requestor",false)}else if(o.roleId==3){i.setProperty("/is_approver",false);i.setProperty("/is_requestor",true)}if(r===undefined){var a=window.location.href;var n=a.split("/");r=n[n.length-1]}const u=new s;u.loadData(backendUrl+"budget/getBudgetById?code="+r,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(u,"budgetingDetailModel");u.dataLoaded().then(function(){this.getView().byId("budgetingPageId").setBusy(false)}.bind(this))},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var o=this.getOwnerComponent().getRouter();o.navTo("dashboard",{},true)}},onApproveButtonClick:function(e){var t=this.getView().byId("budgetingPageId");t.setBusy(true);var s=this.getView().byId("_IDGenText101").getText();$.ajax({type:"POST",data:{Code:s},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"budget/approveBudget",success:function(e,s,i){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new o({type:d.Message,title:"Success",state:l.Success,content:new a({text:"Budget approved"}),beginButton:new r({type:u.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onAmountChange:function(e){const t=this.getView().getModel("budgetingDetailModel");var s=t.getData().BUDGETREQLINESCollection;let o=0;for(let e=0;e<s.length;e++){o+=s[e]["U_Amount"]}console.log(o);const r=this.getView().getModel("budgetingDetailModel");r.setProperty("/U_TotalAmount",o)}})});