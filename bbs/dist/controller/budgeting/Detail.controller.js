sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,o,s,r,i,a,n){"use strict";var u=i.ButtonType;var l=i.DialogType;var d=n.ValueState;return e.extend("frontend.bbs.controller.budgeting.Detail",{onInit:async function(){this.currentRoute=this.getOwnerComponent().getRouter().getHashChanger().getHash();this.oStore=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=this.oStore.get("jwt");var e=this.getOwnerComponent();var t=new o(sap.ui.require.toUrl("frontend/bbs/model/sales_order.json"));this.getView().setModel(t,"salesOrder");this.oRouter=e.getRouter();this.userModel=e.getModel("userModel");this.viewModel=new o;this.getView().setModel(this.viewModel,"viewModel");this.getView().setModel(this.userModel,"userModel");this.oRouter.getRoute("budgetingDetail").attachPatternMatched(this._onObjectMatched,this);var s=new o(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(s,"companies")},_onObjectMatched:function(e){var t=new o;this.getView().setModel(t,"viewModel");this.getView().byId("budgetingPageId").setBusy(true);this.budgetCode=e.getParameter("arguments").budgetID;var s=this.getOwnerComponent().getModel("userModel");if(s===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.buildForm,this)}else{var r=s.getData();var i={userName:r.user.name,roleId:r.user.role_id,roleName:r.role[0].name,status:"success"};this.buildForm("username","checkToken",i)}},buildForm:function(e,t,s){if(s.status=="error"){alert("Error");this.getView().byId("budgetingPageId").setBusy(false)}var r=this.budgetCode;var i=this.getView().getModel("viewModel");if(s.roleId==4||s.roleId==5){i.setProperty("/is_approver",true);i.setProperty("/is_requestor",false)}else if(s.roleId==3){i.setProperty("/is_approver",false);i.setProperty("/is_requestor",true)}if(r===undefined){var a=window.location.href;var n=a.split("/");r=n[n.length-1]}const u=new o;u.loadData(backendUrl+"budget/getBudgetById?code="+r,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(u,"budgetingDetailModel");u.dataLoaded().then(function(){var e=u.getData();console.log(e.U_Status);if(s.roleId==3){i.setProperty("/showFooter",true);i.setProperty("/editable",true);if(e.U_Status!=1){i.setProperty("/showFooter",false);i.setProperty("/editable",false)}}if(s.roleId==5&&e.U_Status==2){i.setProperty("/showFooter",false)}if(s.roleId==4&&e.U_Status==3){i.setProperty("/showFooter",false)}this.getView().byId("budgetingPageId").setBusy(false)}.bind(this))},onNavBack:function(){var e=t.getInstance();var o=e.getPreviousHash();if(o!==undefined){window.history.go(-1)}else{var s=this.getOwnerComponent().getRouter();s.navTo("dashboard",{},true)}},onApproveButtonClick:function(e){var t=this.getView().byId("budgetingPageId");t.setBusy(true);var o=this.getView().byId("_IDGenText101").getText();$.ajax({type:"POST",data:{Code:o},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"budget/approveBudget",success:function(e,o,i){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new s({type:l.Message,title:"Success",state:d.Success,content:new a({text:"Budget approved"}),beginButton:new r({type:u.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,o){console.log("Got an error response: "+t+o)}})},onAmountChange:function(e){const t=this.getView().getModel("budgetingDetailModel");var o=t.getData().BUDGETREQLINESCollection;let s=0;for(let e=0;e<o.length;e++){s+=o[e]["U_Amount"]}console.log(s);const r=this.getView().getModel("budgetingDetailModel");r.setProperty("/U_TotalAmount",s)}})});