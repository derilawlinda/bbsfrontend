sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library","sap/m/Input","sap/m/TextArea","sap/m/MessageBox"],function(e,t,s,a,i,o,r,n,l,g,u){"use strict";var c=o.ButtonType;var d=o.DialogType;var h=n.ValueState;return e.extend("frontend.bbs.controller.budgeting.Detail",{onInit:async function(){this.currentRoute=this.getOwnerComponent().getRouter().getHashChanger().getHash();this.oStore=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=this.oStore.get("jwt");this.company=this.oStore.get("company");var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.userModel=e.getModel("userModel");this.getView().setModel(this.userModel,"userModel");this.oRouter.getRoute("budgetingDetail").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=new s({showFooter:false,editable:false,resubmit:false,is_approver:false,is_requestor:false,is_finance:false});this.getView().setModel(t,"viewModel");this.getView().byId("budgetingPageId").setBusy(true);this.budgetCode=e.getParameter("arguments").budgetID;var a=this.getOwnerComponent().getModel("userModel");if(a===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.buildForm,this)}else{var i=a.getData();var o={userName:i.user.name,roleId:i.user.role_id,roleName:i.role[0].name,status:"success"};this.buildForm("username","checkToken",o)}var r=this.getOwnerComponent().getModel("globalModel").getData();this.path="";if(r["BudgetPath"]!=null||r["BudgetPath"]!=""){this.path=r["BudgetPath"]}},buildForm:function(e,t,a){var i=this.company;if(a.status=="error"){alert("Error");this.getView().byId("budgetingPageId").setBusy(false)}var o=this.budgetCode;var r=this.getView().getModel("viewModel");var n=new sap.ui.model.json.JSONModel;n.setSizeLimit(1e3);n.loadData(backendUrl+"main/getPillar",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=new sap.ui.model.json.JSONModel;n.dataLoaded().then(function(){var e=n.getData();l.setData(e)});this.getView().setModel(l,"companies");var g=new s;g.setSizeLimit(1e3);g.loadData(backendUrl+"coa/getCOAs",{company:i},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(g,"accounts");if(o===undefined){var u=window.location.href;var c=u.split("/");o=c[c.length-1]}const d=new s;d.loadData(backendUrl+"budget/getBudgetById?",{code:o,company:i},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var h=new s;h.setSizeLimit(1e3);h.loadData(backendUrl+"project/getProjects",{company:i},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(h,"projects");this.getView().setModel(d,"budgetingDetailModel");d.dataLoaded().then(function(){var e=d.getData();if(a.roleId==4){r.setProperty("/editable",false);r.setProperty("/is_approver",true);if(e.U_Status==2){r.setProperty("/showFooter",true)}}else if(a.roleId==5){r.setProperty("/editable",false);r.setProperty("/is_approver",true);if(e.U_Status==1){r.setProperty("/showFooter",true)}}else if(a.roleId==3){r.setProperty("/is_requestor",true);r.setProperty("/resubmit",false);if(e.U_Status==4){r.setProperty("/resubmit",true)}if(e.U_Status==4||e.U_Status==1){r.setProperty("/showFooter",true);r.setProperty("/editable",true)}}else if(a.roleId==2){r.setProperty("/editable",true);r.setProperty("/showFooter",true);r.setProperty("/is_requestor",true);r.setProperty("/is_finance",true);if(e.U_Status==5||e.U_Status==99){r.setProperty("/showFooter",false);r.setProperty("/editable",false)}}var t=this.getView().byId("company").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreatePillar").bindAggregation("items",{path:"companies>/0/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});this.getView().byId("CreatePillar").setSelectedKey(e.U_PillarCode);var s=this.getView().byId("CreatePillar").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreateClassification").bindAggregation("items",{path:"companies>"+s+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});this.getView().byId("CreateClassification").setSelectedKey(e.U_ClassificationCode);var i=this.getView().byId("CreateClassification").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreateSubClassification").bindAggregation("items",{path:"companies>"+i+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});this.getView().byId("CreateSubClassification").setSelectedKey(e.U_SubClassCode);var o=this.getView().byId("CreateSubClassification").getSelectedItem().getBindingContext("companies").getPath();this.getView().byId("CreateSubClassification2").bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});this.getView().byId("CreateSubClassification2").setSelectedKey(e.U_SubClass2Code);this.getView().byId("budgetingPageId").setBusy(false);var n=e.BUDGETUSEDCollection;let l=0;if(n.length>0){for(let e=0;e<n.length;e++){l+=Number(n[e]["U_Amount"])}}d.setProperty("/U_TotalUsedBudget",Number(l));var g=Number(e.U_TotalAmount-l);d.setProperty("/U_RemainingBudget",Number(g))}.bind(this))},onProjectChange:function(e){var t=this.getView().getModel("budgetingDetailModel");var s=e.getSource(),a=s.getSelectedKey(),i=s.getValue();if(!a&&i){s.setValueState(h.Error);s.setValueStateText("Please enter a valid Project")}else{s.setValueState(h.None);t.setProperty("/U_Project",i);t.setProperty("/U_ProjectCode",a)}},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var a=this.getOwnerComponent().getRouter();a.navTo("dashboard",{},true)}},onApproveButtonClick:function(e){var t=this.getView().byId("budgetingPageId");var s=this.getView().getModel("viewModel");t.setBusy(true);var o=this.getView().byId("_IDGenText101").getText();const n=this.getView().getModel("budgetingDetailModel");const l=this.getOwnerComponent().getModel("budgeting");var g=this.path;$.ajax({type:"POST",data:{Code:o,company:this.company},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"budget/approveBudget",success:function(e,o,u){t.setBusy(false);if(l){l.setProperty(g+"/U_Status",e["U_Status"])}n.setData(e);n.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:d.Message,title:"Success",state:h.Success,content:new r({text:"Budget approved"}),beginButton:new i({type:c.Emphasized,text:"OK",press:function(){s.setProperty("/showFooter",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,s,a){t.setBusy(false);u.error(e.responseJSON.msg)}})},onRejectButtonClick:function(e){if(!this.rejectBudgetingDialog){this.rejectBudgetingDialog=this.loadFragment({name:"frontend.bbs.view.budgeting.RejectForm"})}this.rejectBudgetingDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},_closeDialog:function(){this.oDialog.close()},onConfirmRejectClick:function(){var e=this.getView().byId("budgetingPageId");var t=this.getView().getModel("budgetingDetailModel").getData();e.setBusy(true);var s=t.Code;var o=t.U_Company;var n=this.getView().byId("RejectionRemarksID").getValue();var l=this.getView().byId("rejectDialog");var g=this.getView().getModel("viewModel");const p=this.getView().getModel("budgetingDetailModel");const b=this.getOwnerComponent().getModel("budgeting");var f=this.path;$.ajax({type:"POST",data:{Code:s,Remarks:n,Company:o},headers:{Authorization:"Bearer "+this.oJWT},crossDomain:true,url:backendUrl+"budget/rejectBudget",success:function(t,s,o){l.close();e.setBusy(false);if(b){b.setProperty(f+"/U_Status",t["U_Status"])}p.setData(t);p.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:d.Message,title:"Success",state:h.Success,content:new r({text:"Budget rejected"}),beginButton:new i({type:c.Emphasized,text:"OK",press:function(){g.setProperty("/showFooter",false);this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()}.bind(this),error:function(e,t,s){u.error(e.responseJSON.msg)}})},onAmountChange:function(e){const t=this.getView().getModel("budgetingDetailModel");var s=t.getData();var a=t.getData().BUDGETREQLINESCollection;let i=0;for(let e=0;e<a.length;e++){i+=Number(a[e]["U_Amount"])}t.setProperty("/U_TotalAmount",i);var o=s.BUDGETUSEDCollection;let r=0;if(o.length>0){for(let e=0;e<o.length;e++){r+=Number(o[e]["U_Amount"])}}t.setProperty("/U_TotalUsedBudget",Number(r));var n=Number(s.U_TotalAmount)-Number(r);t.setProperty("/U_RemainingBudget",Number(n))},onCompanyChange:function(e){this.getView().byId("CreatePillar").setSelectedKey("");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateClassification").setEnabled(false);this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var t=e.getSource(),s=t.getSelectedKey(),a=t.getValue();if(!s&&a){t.setValueState(h.Error);t.setValueStateText("Please enter a valid Company");this.getView().byId("CreatePillar").setEnabled(false)}else{t.setValueState(h.None);var i=e.oSource.getSelectedItem().getBindingContext("companies").getPath();this.companyPath=i;var o=this.getView().byId("CreatePillar");o.setEnabled(true);o.bindAggregation("items",{path:"companies>"+i+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onPillarChange:function(e){var t=this.getView().getModel("budgetingDetailModel");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var s=e.getSource(),a=s.getSelectedKey(),i=s.getValue();if(!a&&i){this.getView().byId("CreateClassification").setEnabled(false);s.setValueState(h.Error);s.setValueStateText("Please enter a valid Pillar")}else{s.setValueState(h.None);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();t.setProperty("/U_Pillar",i);t.setProperty("/U_PillarCode",a);var r=this.getView().byId("CreateClassification");r.setEnabled(true);r.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onClassificationChange:function(e){var t=this.getView().getModel("budgetingDetailModel");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification2").setEnabled(false);var s=e.getSource(),a=s.getSelectedKey(),i=s.getValue();if(!a&&i){this.getView().byId("CreateSubClassification").setEnabled(false);s.setValueState(h.Error);s.setValueStateText("Please enter a valid Classification")}else{s.setValueState(h.None);t.setProperty("/U_Classification",i);t.setProperty("/U_ClassificationCode",a);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var r=this.getView().byId("CreateSubClassification");r.setEnabled(true);r.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onSubClassificationChange:function(e){this.getView().byId("CreateSubClassification2").setSelectedKey("");var t=this.getView().getModel("budgetingDetailModel");var s=e.getSource(),a=s.getSelectedKey(),i=s.getValue();if(!a&&i){this.getView().byId("CreateSubClassification2").setEnabled(false);s.setValueState(h.Error);s.setValueStateText("Please enter a valid SubClassification")}else{s.setValueState(h.None);t.setProperty("/U_SubClass",i);t.setProperty("/U_SubClassCode",a);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var r=this.getView().byId("CreateSubClassification2");r.setEnabled(true);r.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onSubClassification2Change:function(e){var t=this.getView().getModel("budgetingDetailModel");var s=e.getSource(),a=s.getSelectedKey(),i=s.getValue();if(!a&&i){s.setValueState(h.Error);s.setValueStateText("Please enter a valid SubClassification2")}else{s.setValueState(h.None);t.setProperty("/U_SubClass2",i);t.setProperty("/U_SubClass2Code",a)}},onAddPress:function(e){const t=this.getView().getModel("budgetingDetailModel");var s=t.getData();var a={U_AccountCode:"",U_Amount:""};s.BUDGETREQLINESCollection.push(a);var i=new sap.ui.model.json.JSONModel(s);this.getView().setModel(i,"budgetingDetailModel");i.refresh()},hasDuplicates:function(e){return new Set(e).size!==e.length},onSaveButtonClick:function(e){var t=this.getView().byId("budgetingPageId");var s=this.getView().getModel("budgetingDetailModel");s.setProperty("/U_PillarCode",this.getView().byId("CreatePillar").getSelectedKey());s.setProperty("/U_ClassificationCode",this.getView().byId("CreateClassification").getSelectedKey());s.setProperty("/U_SubClassCode",this.getView().byId("CreateSubClassification").getSelectedKey());s.setProperty("/U_SubClass2Code",this.getView().byId("CreateSubClassification2").getSelectedKey());s.setProperty("/U_Pillar",this.getView().byId("CreatePillar").getValue());s.setProperty("/U_Classification",this.getView().byId("CreateClassification").getValue());s.setProperty("/U_SubClass",this.getView().byId("CreateSubClassification").getValue());s.setProperty("/U_SubClass2",this.getView().byId("CreateSubClassification2").getValue());var o=JSON.stringify(s.getData());console.log(o);var n=this.oJWT;var l=[];s.getData().BUDGETREQLINESCollection.forEach(function(e){l.push(e.U_AccountCode)});if(this.hasDuplicates(l)){u.error("Account must be unique")}else{t.setBusy(true);$.ajax({type:"POST",data:o,headers:{Authorization:"Bearer "+n},crossDomain:true,url:backendUrl+"budget/saveBudget",contentType:"application/json",success:function(e,s,o){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:d.Message,title:"Success",state:h.Success,content:new r({text:"Budget saved"}),beginButton:new i({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,s,a){t.setBusy(false);u.error(e.responseJSON.msg)}})}},onResubmitButtonClick:function(e){const t=this.getView().getModel("budgetingDetailModel");const s=this.getOwnerComponent().getModel("budgeting");var o=this.path;var n=this.getView().byId("budgetingPageId");n.setBusy(true);var l=JSON.stringify(t.getData());var g=this.oJWT;$.ajax({type:"POST",data:l,headers:{Authorization:"Bearer "+g},crossDomain:true,url:backendUrl+"budget/resubmitBudget",contentType:"application/json",success:function(e,l,g){n.setBusy(false);if(s){s.setProperty(o+"/U_Status",e["U_Status"])}t.setData(e);t.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:d.Message,title:"Success",state:h.Success,content:new r({text:"Budget resubmitted"}),beginButton:new i({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){n.setBusy(false);u.error(e.responseJSON.msg)}})},onCancelButtonClick:function(e){var t=this.getView().byId("budgetingPageId");var s=this.oJWT;var o=this.company;const n=this.getView().getModel("budgetingDetailModel");var l=n.getData();const g=this.getOwnerComponent().getModel("budgeting");var p=this.path;u.warning("Cancel this Budget ?",{actions:[u.Action.OK,u.Action.CANCEL],emphasizedAction:u.Action.OK,onClose:function(e){if(e=="OK"){t.setBusy(true);$.ajax({type:"POST",data:{Code:l.Code,Company:o},headers:{Authorization:"Bearer "+s},crossDomain:true,url:backendUrl+"budget/cancelBudget",success:function(e,s,o){t.setBusy(false);if(g){g.setProperty(p+"/U_Status",e["U_Status"])}n.setData(e);n.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:d.Message,title:"Info",state:h.Information,content:new r({text:"Budget cancelled"}),beginButton:new i({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,s,a){t.setBusy(false);u.error(e.responseJSON.msg)}})}}})},onCloseButtonClick:function(e){var t=this.getView().byId("budgetingPageId");var s=this.oJWT;var o=this.company;const n=this.getView().getModel("budgetingDetailModel");var l=n.getData();const g=this.getOwnerComponent().getModel("budgeting");var p=this.path;u.warning("Close this Budget ?",{actions:[u.Action.OK,u.Action.CANCEL],emphasizedAction:u.Action.OK,onClose:function(e){if(e=="OK"){t.setBusy(true);$.ajax({type:"POST",data:{Code:l.Code,Company:o},headers:{Authorization:"Bearer "+s},crossDomain:true,url:backendUrl+"budget/closeBudget",success:function(e,s,o){t.setBusy(false);if(g){g.setProperty(p+"/U_Status",e["U_Status"])}n.setData(e);n.refresh();if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:d.Message,title:"Info",state:h.Information,content:new r({text:"Budget closed"}),beginButton:new i({type:c.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,s,a){t.setBusy(false);u.error(e.responseJSON.msg)}})}}})},onDelete:function(e){var t=e.getParameters().row;var s=t.getIndex();var a=this.getView().getModel("budgetingDetailModel");var i=a.getData().BUDGETREQLINESCollection;i.splice(s,1);a.setProperty("/BUDGETREQLINESCollection",i);a.refresh();this.onAmountChange()},dateFormatter:function(e){var t=new Date(e);var s=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var a=s.format(t);return a},handlePrintButtonPressed:function(e){var t=this.getView().getModel("budgetingDetailModel");var s=t.getData();t.setProperty("/U_Pillar",this.getView().byId("CreatePillar").getValue());t.setProperty("/U_Classification",this.getView().byId("CreateClassification").getValue());t.setProperty("/U_SubClass",this.getView().byId("CreateSubClassification").getValue());t.setProperty("/U_SubClass2",this.getView().byId("CreateSubClassification2").getValue());var a=JSON.stringify(t.getData());var i=this.oJWT;$.ajax({type:"POST",data:a,headers:{Authorization:"Bearer "+i},crossDomain:true,url:backendUrl+"budget/printBudget",contentType:"application/json",responseType:"arraybuffer",success:function(e,t,s){var a=atob(e);var i=new Array(a.length);for(var o=0;o<a.length;o++){i[o]=a.charCodeAt(o)}var r=new Uint8Array(i);var n=new Blob([r],{type:"application/pdf;base64"});var l=URL.createObjectURL(n);window.open(l)},error:function(e,t,s){pageDOM.setBusy(false);u.error(e.responseJSON.msg)}})},base64ToArrayBuffer:function(e){return bytes},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else if(e==5){return"Closed"}else if(e==99){return"Cancelled"}else{return"Rejected"}}})});