sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/ODataModel","sap/m/MessageToast","frontend/bbs/model/models","sap/ui/core/library","sap/m/MessageBox","frontend/bbs/utils/Validator"],function(e,t,a,i,s,o,n,r,l){"use strict";var g;var u;var d=[];var c=n.ValueState;return e.extend("frontend.bbs.controller.budgeting.List",{onInit:async function(){this.getView().byId("idBudgetTable").setBusy(true);var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");var i=new a;i.loadData(backendUrl+"getBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var s=new sap.ui.model.json.JSONModel({showCreateButton:true});this.getView().setModel(s,"viewModel");i.dataLoaded().then(function(){this.getView().byId("idBudgetTable").setBusy(false)}.bind(this));this.getView().setModel(i,"budgeting");var o=new a;o.loadData(backendUrl+"project/getProjects",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(o,"projects");var n=new a;n.setSizeLimit(1e3);n.loadData(backendUrl+"coa/getCOAs",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(n,"accounts");var r=this.getOwnerComponent().getModel("userModel");if(r===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.toggleCreateButton,this)}else{var l=r.getData();var g={userName:l.user.name,roleId:l.user.role_id,roleName:l.role[0].name,status:"success"};this.toggleCreateButton("username","checkToken",g)}},toggleCreateButton:function(e,t,a){if(a.roleId==4||a.roleId==5){this.getView().getModel("viewModel").setProperty("/showCreateButton",false)}},search:function(e,t){if(t!=g){d=[]}if(!Array.isArray(e))return d;var a=this;e.forEach(function(e){if(e.subheader===t){const a=e.nodes&&Array.isArray(e.nodes)?e.nodes.filter(e=>e.value===t):[];d.push(e)}else{a.search(e.nodes,t)}g=t});return d},onCreateButtonClick:function(e){if(!this.createBudgetingDialog){this.createBudgetingDialog=this.loadFragment({name:"frontend.bbs.view.budgeting.CreateForm"})}this.createBudgetingDialog.then(function(e){this.getView().byId("CreatePillar").setSelectedKey("");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreatePillar").setEnabled(false);this.getView().byId("CreateClassification").setEnabled(false);this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);this.oDialog=e;this.oDialog.open();var t=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(t,"createFragmentViewModel");var a=new sap.ui.model.json.JSONModel({U_TotalAmount:0});this.getView().setModel(a,"budgetingDetailModel");var i=new sap.ui.model.json.JSONModel;this.getView().setModel(i,"new_budgeting_accounts");this.getView().getModel("new_budgeting_accounts").setProperty("/BUDGETREQLINESCollection",[])}.bind(this))},onSaveButtonClick:function(e){var t=this.byId("tableId");var a=this.oDialog;const i=this.getView().getModel("budgetingDetailModel");const o=this.getView().getModel("new_budgeting_accounts");const n=o.getData();var l=this.getView().getModel("budgeting");i.setProperty("/BUDGETREQLINESCollection",o.getData().BUDGETREQLINESCollection);var g=i.getProperty("/");var u=this.getView();var d=this.oJWT;var c=i.getData();var b=false;if(c.BUDGETREQLINESCollection.length<1){r.error("Account can not empty")}else{a.setBusy(true);var g=i.getProperty("/");$.ajax({type:"POST",data:JSON.stringify(g),crossDomain:true,headers:{Authorization:"Bearer "+d},url:backendUrl+"budget/createBudget",contentType:"application/json",success:function(e,t,i){a.setBusy(false);a.close();s.show("Budget created");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});l.loadData(backendUrl+"getBudget",null,true,"GET",false,false,{Authorization:"Bearer "+d});u.getModel("budgeting").refresh()},error:function(e,t,a){console.log("Got an error response: "+t+a)}})}},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_closeDialog:function(){this.oDialog.close()},buttonFormatter:function(e){if(e==2||e==3){return"Accept"}else if(e==1){return"Attention"}else{return"Reject"}},objectFormatter:function(e){if(e==2||e==3){return"Success"}else if(e==1){return"Warning"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},dateFormatter:function(e){var t=new Date(e);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var i=a.format(t);return i},onNavBack:function(e){var a,i;a=t.getInstance();i=a.getPreviousHash();if(i!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},onPress:function(e){var t=this.getOwnerComponent().getRouter();var a=e.getSource();var i=a.getCells()[0].getText();t.navTo("budgetingDetail",{budgetID:i})},onAddPress:function(e){var t=new l;if(t.validate(this.byId("createBudgetForm"))){const e=this.getView().getModel("new_budgeting_accounts");var a=e.getData();var i={U_AccountCode:"",U_Amount:0};a.BUDGETREQLINESCollection.push(i);var s=new sap.ui.model.json.JSONModel(a);this.getView().setModel(s,"new_budgeting_accounts");s.refresh()}},onAmountChange:function(e){const t=this.getView().getModel("new_budgeting_accounts");var a=t.getData().BUDGETREQLINESCollection;let i=0;for(let e=0;e<a.length;e++){i+=a[e]["U_Amount"]}const s=this.getView().getModel("budgetingDetailModel");s.setProperty("/U_TotalAmount",i)},onCompanyChange:function(e){this.getView().byId("CreatePillar").setSelectedKey("");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateClassification").setEnabled(false);this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var t=e.getSource(),a=t.getSelectedKey(),i=t.getValue();if(!a&&i){this.getView().byId("CreatePillar").setEnabled(false);t.setValueState(c.Error);t.setValueStateText("Please enter a valid Company")}else{t.setValueState(c.None);var s=e.oSource.getSelectedItem().getBindingContext("companies").getPath();this.companyPath=s;var o=this.getView().byId("CreatePillar");o.setEnabled(true);o.bindAggregation("items",{path:"companies>"+s+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});o.setSelectedKey(a)}},onPillarChange:function(e){var t=this.getView().getModel("budgetingDetailModel");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){this.getView().byId("CreateClassification").setEnabled(false);a.setValueState(c.Error);a.setValueStateText("Please enter a valid Pillar")}else{a.setValueState(c.None);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();t.setProperty("/U_Pillar",s);t.setProperty("/U_PillarCode",i);var n=this.getView().byId("CreateClassification");n.setEnabled(true);n.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onClassificationChange:function(e){var t=this.getView().getModel("budgetingDetailModel");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification2").setEnabled(false);var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){this.getView().byId("CreateSubClassification").setEnabled(false);a.setValueState(c.Error);a.setValueStateText("Please enter a valid Classification")}else{a.setValueState(c.None);t.setProperty("/U_Classification",s);t.setProperty("/U_ClassificationCode",i);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var n=this.getView().byId("CreateSubClassification");n.setEnabled(true);n.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onSubClassificationChange:function(e){this.getView().byId("CreateSubClassification2").setSelectedKey("");var t=this.getView().getModel("budgetingDetailModel");var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){this.getView().byId("CreateSubClassification2").setEnabled(false);a.setValueState(c.Error);a.setValueStateText("Please enter a valid SubClassification")}else{a.setValueState(c.None);t.setProperty("/U_SubClass",s);t.setProperty("/U_SubClassCode",i);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var n=this.getView().byId("CreateSubClassification2");n.setEnabled(true);n.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onSubClassification2Change:function(e){var t=this.getView().getModel("budgetingDetailModel");var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){a.setValueState(c.Error);a.setValueStateText("Please enter a valid SubClassification2")}else{a.setValueState(c.None);t.setProperty("/U_SubClass2",s);t.setProperty("/U_SubClass2Code",i)}},onProjectChange:function(e){var t=this.getView().getModel("budgetingDetailModel");var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){a.setValueState(c.Error);a.setValueStateText("Please enter a valid Project")}else{a.setValueState(c.None);t.setProperty("/U_Project",s);t.setProperty("/U_ProjectCode",i)}},onAccountChange:function(e){var t=e.getSource(),a=t.getSelectedKey(),i=t.getValue();if(!a&&i){t.setValueState(c.Error);t.setValueStateText("Please enter a valid Account")}else{t.setValueState(c.None)}},onDelete:function(e){var t=e.getParameters().row;var a=t.getIndex();var i=this.getView().getModel("new_budgeting_accounts");var s=i.getData().BUDGETREQLINESCollection;s.splice(a,1);i.setProperty("/BUDGETREQLINESCollection",s);i.refresh();this.onAmountChange()},_validateInput:function(e){var t="None";var a=false;var i=e.getBinding("value");try{i.getType().validateValue(e.getValue())}catch(e){t="Error";a=true}e.setValueState(t);return a}})});