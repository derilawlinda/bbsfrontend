sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","frontend/bbs/model/PagingJSONModel","sap/ui/model/odata/v4/ODataModel","sap/m/MessageToast","frontend/bbs/model/models","sap/ui/core/library","sap/m/MessageBox","frontend/bbs/utils/Validator","sap/ui/core/Fragment","sap/ui/Device","sap/m/Dialog","sap/m/library","sap/m/Button"],function(e,t,a,i,s,o,n,r,l,g,d,u,c,h){"use strict";var f;var b;var p=[];var y=c.ButtonType;var C=c.DialogType;var S=n.ValueState;var S=n.ValueState;return e.extend("frontend.bbs.controller.budgeting.List",{onInit:async function(){this.getView().byId("idBudgetTable").setBusy(true);var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);var i=t.get("company");this.company=i;this._mViewSettingsDialogs={};var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");var s=new a;s.setSizeLimit(1e3);s.loadData(backendUrl+"getBudget",{company:i},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var o=new sap.ui.model.json.JSONModel({showCreateButton:true,is_approver:false,is_requestor:false});this.getView().setModel(o,"viewModel");var n=new sap.ui.model.json.JSONModel({sortBy:"",filterBy:""});this.getView().setModel(n,"searchModel");var r=new sap.ui.model.json.JSONModel;r.loadData(backendUrl+"main/getPillar",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=new sap.ui.model.json.JSONModel;r.dataLoaded().then(function(){var e=r.getData();l.setData(e)});this.getView().setModel(l,"companies");s.dataLoaded().then(function(){this.getView().byId("idBudgetTable").setBusy(false)}.bind(this));this.getOwnerComponent().setModel(s,"budgeting");var g=new a;g.loadData(backendUrl+"project/getProjects",{company:i},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(g,"projects");var d=new a;d.setSizeLimit(1e3);d.loadData(backendUrl+"coa/getCOAs",{company:i},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(d,"accounts");var u=this.getOwnerComponent().getModel("userModel");if(u===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.toggleCreateButton,this)}else{var c=u.getData();var h={userName:c.user.name,roleId:c.user.role_id,roleName:c.role[0].name,status:"success"};this.toggleCreateButton("username","checkToken",h)}},toggleCreateButton:function(e,t,a){if(a.roleId==4||a.roleId==5){this.getView().getModel("viewModel").setProperty("/showCreateButton",false);this.getView().getModel("viewModel").setProperty("/is_approver",true)}},search:function(e,t){if(t!=f){p=[]}if(!Array.isArray(e))return p;var a=this;e.forEach(function(e){if(e.subheader===t){const a=e.nodes&&Array.isArray(e.nodes)?e.nodes.filter(e=>e.value===t):[];p.push(e)}else{a.search(e.nodes,t)}f=t});return p},onCreateButtonClick:function(e){if(!this.createBudgetingDialog){this.createBudgetingDialog=this.loadFragment({name:"frontend.bbs.view.budgeting.CreateForm"})}this.createBudgetingDialog.then(function(e){this.getView().byId("CreatePillar").setSelectedKey("");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateClassification").setEnabled(false);this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var t=this.getView().byId("CreatePillar");t.setEnabled(true);t.bindAggregation("items",{path:"companies>/0/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});this.oDialog=e;this.oDialog.open();var a=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(a,"createFragmentViewModel");var i=new sap.ui.model.json.JSONModel({U_TotalAmount:0,U_Company:this.company});this.getView().setModel(i,"budgetingDetailModel");var s=new sap.ui.model.json.JSONModel;this.getView().setModel(s,"new_budgeting_accounts");this.getView().getModel("new_budgeting_accounts").setProperty("/BUDGETREQLINESCollection",[])}.bind(this))},onSaveButtonClick:function(e){var t=this.byId("tableId");var a=this.oDialog;const i=this.getView().getModel("budgetingDetailModel");const o=this.getView().getModel("new_budgeting_accounts");const n=o.getData();var l=this.getView().getModel("budgeting");l.setSizeLimit(1e3);i.setProperty("/BUDGETREQLINESCollection",o.getData().BUDGETREQLINESCollection);var g=i.getProperty("/");var d=this.getView();var c=this.oJWT;var f=i.getData();var b=false;var p=this.company;var m=[];o.getData().BUDGETREQLINESCollection.forEach(function(e){m.push(e.U_AccountCode)});if(this.hasDuplicates(m)){r.error("Account must be unique")}else{if(f.BUDGETREQLINESCollection.length<1){r.error("Account can not empty")}else{a.setBusy(true);var g=i.getProperty("/");$.ajax({type:"POST",data:JSON.stringify(g),crossDomain:true,headers:{Authorization:"Bearer "+c},url:backendUrl+"budget/createBudget",contentType:"application/json",success:function(e,t,i){a.setBusy(false);a.close();s.show("Budget created");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});l.loadData(backendUrl+"getBudget",{company:p},true,"GET",false,false,{Authorization:"Bearer "+c});d.getModel("budgeting").refresh()},error:function(e,t,i){a.setBusy(false);if(!this.oErrorDialog){this.oErrorDialog=new u({type:C.Message,title:"Error",state:S.Error,content:new Text({text:e.responseJSON.msg}),beginButton:new h({type:y.Emphasized,text:"OK",press:function(){this.oErrorDialog.close()}.bind(this)})})}this.oErrorDialog.open()}})}}},hasDuplicates:function(e){return new Set(e).size!==e.length},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_closeDialog:function(){this.oDialog.close()},buttonFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else{return"Error"}},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else if(e==5){return"Closed"}else if(e==99){return"Cancelled"}else{return"Rejected"}},dateFormatter:function(e){var t=new Date(e);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var i=a.format(t);return i},onNavBack:function(e){var a,i;a=t.getInstance();i=a.getPreviousHash();if(i!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},onPress:function(e){var t=this.getOwnerComponent().getRouter();var a=e.getSource();var i=a.getCells()[0].getText();var s=a.getBindingContext("budgeting").getPath();this.getOwnerComponent().getModel("globalModel").setData({BudgetPath:s});t.navTo("budgetingDetail",{budgetID:i})},onAddPress:function(e){var t=new l;if(t.validate(this.byId("createBudgetForm"))){const e=this.getView().getModel("new_budgeting_accounts");var a=e.getData();var i={U_AccountCode:"",U_Amount:0};a.BUDGETREQLINESCollection.push(i);var s=new sap.ui.model.json.JSONModel(a);this.getView().setModel(s,"new_budgeting_accounts");s.refresh()}},onAmountChange:function(e){const t=this.getView().getModel("new_budgeting_accounts");var a=t.getData().BUDGETREQLINESCollection;let i=0;for(let e=0;e<a.length;e++){i+=Number(a[e]["U_Amount"])}const s=this.getView().getModel("budgetingDetailModel");s.setProperty("/U_TotalAmount",i)},onCompanyChange:function(e){this.getView().byId("CreatePillar").setSelectedKey("");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateClassification").setEnabled(false);this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var t=e.getSource(),a=t.getSelectedKey(),i=t.getValue();if(!a&&i){this.getView().byId("CreatePillar").setEnabled(false);t.setValueState(S.Error);t.setValueStateText("Please enter a valid Company")}else{t.setValueState(S.None);var s=e.oSource.getSelectedItem().getBindingContext("companies").getPath();this.companyPath=s;var o=this.getView().byId("CreatePillar");o.setEnabled(true);o.bindAggregation("items",{path:"companies>"+s+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})});o.setSelectedKey(a)}},onPillarChange:function(e){var t=this.getView().getModel("budgetingDetailModel");this.getView().byId("CreateClassification").setSelectedKey("");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification").setEnabled(false);this.getView().byId("CreateSubClassification2").setEnabled(false);var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){this.getView().byId("CreateClassification").setEnabled(false);a.setValueState(S.Error);a.setValueStateText("Please enter a valid Pillar")}else{a.setValueState(S.None);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();t.setProperty("/U_Pillar",s);t.setProperty("/U_PillarCode",i);var n=this.getView().byId("CreateClassification");n.setEnabled(true);n.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onClassificationChange:function(e){var t=this.getView().getModel("budgetingDetailModel");this.getView().byId("CreateSubClassification").setSelectedKey("");this.getView().byId("CreateSubClassification2").setSelectedKey("");this.getView().byId("CreateSubClassification2").setEnabled(false);var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){this.getView().byId("CreateSubClassification").setEnabled(false);a.setValueState(S.Error);a.setValueStateText("Please enter a valid Classification")}else{a.setValueState(S.None);t.setProperty("/U_Classification",s);t.setProperty("/U_ClassificationCode",i);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var n=this.getView().byId("CreateSubClassification");n.setEnabled(true);n.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onSubClassificationChange:function(e){this.getView().byId("CreateSubClassification2").setSelectedKey("");var t=this.getView().getModel("budgetingDetailModel");var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){this.getView().byId("CreateSubClassification2").setEnabled(false);a.setValueState(S.Error);a.setValueStateText("Please enter a valid SubClassification")}else{a.setValueState(S.None);t.setProperty("/U_SubClass",s);t.setProperty("/U_SubClassCode",i);var o=e.oSource.getSelectedItem().getBindingContext("companies").getPath();var n=this.getView().byId("CreateSubClassification2");n.setEnabled(true);n.bindAggregation("items",{path:"companies>"+o+"/nodes",template:new sap.ui.core.Item({key:"{companies>code}",text:"{companies>text}"})})}},onSubClassification2Change:function(e){var t=this.getView().getModel("budgetingDetailModel");var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){a.setValueState(S.Error);a.setValueStateText("Please enter a valid SubClassification2")}else{a.setValueState(S.None);t.setProperty("/U_SubClass2",s);t.setProperty("/U_SubClass2Code",i)}},onProjectChange:function(e){var t=this.getView().getModel("budgetingDetailModel");var a=e.getSource(),i=a.getSelectedKey(),s=a.getValue();if(!i&&s){a.setValueState(S.Error);a.setValueStateText("Please enter a valid Project")}else{a.setValueState(S.None);console.log(s);t.setProperty("/U_Project",s);t.setProperty("/U_ProjectCode",i);console.log(t);console.log(t.getData())}},onAccountChange:function(e){var t=e.getSource(),a=t.getSelectedKey(),i=t.getValue();if(!a&&i){t.setValueState(S.Error);t.setValueStateText("Please enter a valid Account")}else{t.setValueState(S.None)}},onDelete:function(e){var t=e.getParameters().row;var a=t.getIndex();var i=this.getView().getModel("new_budgeting_accounts");var s=i.getData().BUDGETREQLINESCollection;s.splice(a,1);i.setProperty("/BUDGETREQLINESCollection",s);i.refresh();this.onAmountChange()},_validateInput:function(e){var t="None";var a=false;var i=e.getBinding("value");try{i.getType().validateValue(e.getValue())}catch(e){t="Error";a=true}e.setValueState(t);return a},onSearch:function(e){var t=e.getParameters();console.log(t);if(t.filterKeys){var i=Object.keys(t.filterKeys).toString()}else{var i=""}this.getView().byId("idBudgetTable").setBusy(true);var s=this.getView().byId("searchField").getValue();var o=this.oJWT;var n=new a;n.loadData(backendUrl+"getBudget",{search:s,status:i,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+o});n.dataLoaded().then(function(){this.getView().byId("idBudgetTable").setBusy(false)}.bind(this));this.getView().setModel(n,"budgeting")},handleFilterButtonPressed:function(){this.getViewSettingsDialog("frontend.bbs.view.budgeting.FilterForm").then(function(e){e.open()})},getViewSettingsDialog:function(e){var t=this._mViewSettingsDialogs[e];if(!t){t=g.load({id:this.getView().getId(),name:e,controller:this}).then(function(e){if(d.system.desktop){e.addStyleClass("sapUiSizeCompact")}return e});this._mViewSettingsDialogs[e]=t}return t}})});