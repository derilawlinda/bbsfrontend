sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,s,a,o,r,i,l){"use strict";var n=r.ButtonType;var u=r.DialogType;var d=l.ValueState;return e.extend("frontend.bbs.controller.materialIssue.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("materialIssueDetail").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(e){this.getView().byId("materialIssueLineTableID").setBusy(true);var t=new s;this.getView().setModel(t,"viewModel");var a=new s;this.getView().setModel(a,"accounts");var o=new s;o.setSizeLimit(5e3);this.getView().setModel(o,"items");this.getView().byId("materialIssuePageID").setBusy(true);var r=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=r.get("jwt");var i=new s;await i.loadData(backendUrl+"checkToken",null,true,"POST",false,false,{Authorization:"Bearer "+this.oJWT});i.dataLoaded().then(function(){var e=i.getData();if(e.user.role_id==3){t.setProperty("/editable",true)}else{t.setProperty("/editable",false)}});this.getView().bindElement({path:"/value/"+window.decodeURIComponent(e.getParameter("arguments").ID),model:"materialIssue"});var l=e.getParameter("arguments").ID;if(l===undefined){var n=window.location.href;var u=n.split("/");l=u[u.length-1]}const d=new s;d.loadData(backendUrl+"materialIssue/getMaterialIssueById?code="+l,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(d,"materialIssueDetailModel");var g=new s;g.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(g,"budgeting");d.dataLoaded().then(function(){var e=i.getData();var o=this.getView().getModel("materialIssueDetailModel").getData();if(e.user.role_id==4){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==3){t.setProperty("/showFooter",false)}}else if(e.user.role_id==5){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==2){t.setProperty("/showFooter",false)}}else if(e.user.role_id==3){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",true);if(o.U_Status!=1){t.setProperty("/showFooter",false);t.setProperty("/editable",false)}}const r=new s;r.loadData(backendUrl+"budget/getBudgetById?code="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(r,"budget");a.loadData(backendUrl+"coa/getCOAsByBudget?budgetCode="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=this.getView().byId("materialIssueLineTableID");var n=this.getView().getModel("items");n.setProperty("/data",[]);var u=n.getData();var d=new s;var g=[];for(let e=0;e<o.MATERIALISSUELINESCollection.length;e++){if(!(o.MATERIALISSUELINESCollection[e].U_AccountCode.toString()in g)){g.push(o.MATERIALISSUELINESCollection[e].U_AccountCode)}}var c=[...new Set(g)];for(let e=0;e<c.length;e++){this.getView().byId("materialIssuePageID").setBusy(true);d.loadData(backendUrl+"items/getItemsByAccount?accountCode="+c[e],null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});d.dataLoaded().then(function(){var t=d.getData();u.data[c[e]]=t;var s=new sap.ui.model.json.JSONModel(u);this.getView().setModel(s,"items");s.refresh();this.getView().byId("materialIssuePageID").setBusy(false)}.bind(this))}for(let e=0;e<o.MATERIALISSUELINESCollection.length;e++){l.getRows()[e].getCells()[1].setBusy(true);let t=o.MATERIALISSUELINESCollection[e].U_AccountCode.toString();l.getRows()[e].getCells()[1].bindAggregation("items",{path:"items>/data/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});l.getRows()[e].getCells()[1].setBusy(false)}}.bind(this));this.getView().byId("materialIssueLineTableID").setBusy(false)},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var a=this.getOwnerComponent().getRouter();a.navTo("dashboard",{},true)}},onApproveButtonClick:function(e){var t=this.getView().byId("materialIssuePageID");var s=this.getView().getModel("viewModel");t.setBusy(true);var r=this.getView().byId("_IDGenText101").getText();const l=this.getView().getModel("materialIssueDetailModel");var g=l.getProperty("/");var c=this.getView();var h=this.oDialog;var I=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(g),headers:{Authorization:"Bearer "+I},crossDomain:true,url:backendUrl+"materialIssue/approveMI",contentType:"application/json",success:function(e,r,l){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Material Issue approved"}),beginButton:new o({type:n.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});s.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onSaveButtonClick:function(e){var t=this.getView().byId("materialIssuePageID");t.setBusy(true);var s=this.getView().getModel("materialIssueDetailModel");var r=JSON.stringify(s.getData());var l=this.oJWT;$.ajax({type:"POST",data:r,headers:{Authorization:"Bearer "+l},crossDomain:true,url:backendUrl+"materialIssue/saveMI",contentType:"application/json",success:function(e,s,r){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Material Issue saved"}),beginButton:new o({type:n.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onDelete:function(e){var t=e.getParameters().row;var s=t.getIndex();var a=this.getView().getModel("materialIssueDetailModel");var o=a.getData().MATERIALISSUELINESCollection;o.splice(s,1);a.setProperty("/MATERIALISSUELINESCollection",o);a.refresh()},onBudgetChange:async function(e){var t=e.getSource(),s=t.getSelectedKey(),a=t.getValue();if(!s&&a){t.setValueState(d.Error);t.setValueStateText("Please enter a valid Budget Code")}else{t.setValueState(d.None)}if(t.getValueState()==d.None){this.getView().byId("materialIssuePageID").setBusy(true);var o=this.getView().getModel("accounts");o.loadData(backendUrl+"coa/getCOAsByBudget?budgetCode="+s,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});o.refresh();var r=this.getView().getModel("materialIssueDetailModel");r.setProperty("/MATERIALISSUELINESCollection",[]);r.refresh();var i=parseInt(e.getParameters("selectedItem").value);var l=this.getView().getModel("budget");await l.loadData(backendUrl+"budget/getBudgetById?code="+i,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});l.refresh();this.getView().byId("materialIssuePageID").setBusy(false)}},onAddPress:function(e){const t=this.getView().getModel("materialIssueDetailModel");var s=t.getData();var a={U_AccountCode:"",U_ItemCode:"",U_Qty:""};console.log(s);s.MATERIALISSUELINESCollection.push(a);var o=new sap.ui.model.json.JSONModel(s);this.getView().setModel(o,"materialIssueDetailModel");o.refresh()},onAccountCodeChange:async function(e){var t=e.getSource().getSelectedKey();var a=e.getSource().getParent();a.getCells()[1].setBusy(true);a.getCells()[1].setSelectedKey("");a.getCells()[1].setEnabled(true);a.getCells()[1].setEnabled(true);var o=this.getView().getModel("items");var r=o.getData();if(!(t.toString()in r)){var i=new s;await i.loadData(backendUrl+"items/getItemsByAccount?accountCode="+t+"",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=i.getData();r[t]=l;var n=new sap.ui.model.json.JSONModel(r);this.getView().setModel(n,"items");n.refresh()}a.getCells()[1].bindAggregation("items",{path:"items>/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});a.getCells()[1].setBusy(false)}})});