sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/m/library","sap/ui/model/json/JSONModel","frontend/bbs/libs/lodash"],function(e,t,a,r){"use strict";var o=a.ButtonType;var s=a.DialogType;return e.extend("frontend.bbs.controller.materialIssue.Index",{onInit:async function(){this.getView().byId("materialIssueTableID").setBusy(true);var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");var a=new r(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(a,"items");var o=new r;o.loadData(backendUrl+"materialIssue/getMaterialIssues",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(o,"materialIssue");o.dataLoaded().then(function(){this.getView().byId("materialIssueTableID").setBusy(false)}.bind(this));var s=new sap.ui.model.json.JSONModel({U_RemainingBudget:0});this.getView().setModel(s,"budgetHeader");var i=new r;i.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(i,"budgeting");var n=new sap.ui.model.json.JSONModel;this.getView().setModel(n,"new_mi_items");this.getView().getModel("new_mi_items").setProperty("/MATERIALISSUELINESCollection",[])},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},buttonFormatter:function(e){if(e=="Issued"){return"Accept"}else{return"Attention"}},onPress:function(e){var t=this.getOwnerComponent().getRouter();var a=e.getSource();var r=a.getCells()[0].getText();t.navTo("materialIssueDetail",{ID:r})},onNavBack:function(e){var a,r;a=t.getInstance();r=a.getPreviousHash();if(r!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},onBudgetChange:function(e){var t=parseInt(e.getParameters("selectedItem").value);var a=new r;a.loadData(backendUrl+"budget/getBudgetById?code="+t,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var o=a.getData().value;let s=_.find(o,function(e){if(e.Code==t){return true}});var i=s.U_TotalAmount;var n=s.BUDGETUSEDCollection;let l=0;for(let e=0;e<n.length;e++){l+=n[e]["U_Amount"]}s.U_RemainingBudget=i-l;var u=this.getView().getModel("budgetHeader");u.setData(s)},onCreateButtonClick:function(e){if(!this.createMaterialIssueDialog){this.createMaterialIssueDialog=this.loadFragment({name:"frontend.bbs.view.materialIssue.CreateForm"})}this.createMaterialIssueDialog.then(function(e){var t=new sap.ui.model.json.JSONModel({Date:new Date});var a=new sap.ui.model.json.JSONModel;this.getView().setModel(a,"materialIssueHeader");this.getView().setModel(t,"createFragmentViewModel");this.oDialog=e;this.oDialog.open();var r=new sap.ui.model.json.JSONModel;var o=this.getView().getModel("budgetHeader");var s=[];r.setData(s);o.setData(s);this.getView().setModel(r,"materialIssueDetailModel");this.getView().getModel("new_mi_items").setProperty("/MATERIALISSUELINESCollection",[])}.bind(this))},_closeDialog:function(){this.oDialog.close()},onAddPress:function(e){const t=this.getView().getModel("new_mi_items");var a=t.getData();var r={U_AccountCode:"",U_ItemCode:"",U_Qty:""};a.MATERIALISSUELINESCollection.push(r);var o=new sap.ui.model.json.JSONModel(a);this.getView().setModel(o,"new_mi_items");o.refresh()},onSaveButtonClick:function(e){const t=this.getView().getModel("materialIssueHeader");const a=this.getView().getModel("new_mi_items");var r=this.getView().getModel("materialIssue");t.setProperty("/MATERIALISSUELINESCollection",a.getData().MATERIALISSUELINESCollection);var o=t.getProperty("/");var s=this.getView();var i=this.oDialog;var n=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(o),crossDomain:true,headers:{Authorization:"Bearer "+n},url:backendUrl+"materialIssue/createMaterialIssue",contentType:"application/json",success:function(e,t,a){i.close();r.loadData(backendUrl+"materialIssue/getMaterialIssues",null,true,"GET",false,false,{Authorization:"Bearer "+n});s.getModel("materialIssue").refresh()},error:function(e,t,a){console.log("Got an error response: "+t+a)}})},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},dateFormatter:function(e){var t=new Date(e);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var r=a.format(t);return r},buttonFormatter:function(e){if(e==2||e==3){return"Accept"}else if(e==1){return"Attention"}else{return"Reject"}}})});