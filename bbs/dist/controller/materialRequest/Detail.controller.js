sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,s,a,o,i,r,l){"use strict";var n=i.ButtonType;var u=i.DialogType;var d=l.ValueState;return e.extend("frontend.bbs.controller.materialRequest.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("materialRequestDetail").attachPatternMatched(this._onObjectMatched,this);var t=new s(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(t,"companies")},_onObjectMatched:function(e){var t=new s;this.getView().setModel(t,"viewModel");var a=new s;a.setSizeLimit(5e3);this.getView().setModel(a,"items");this.getView().byId("materialRequestPageID").setBusy(true);var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=o.get("jwt");this.materialRequestCode=e.getParameter("arguments").materialRequestID;var i=this.getOwnerComponent().getModel("userModel");if(i===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.buildForm,this)}else{var r=i.getData();var l={userName:r.user.name,roleId:r.user.role_id,roleName:r.role[0].name,status:"success"};this.buildForm("username","checkToken",l)}},buildForm:function(e,t,a){if(a.status=="error"){alert("Error");this.getView().byId("materialRequestPageID").setBusy(false)}var o=this.materialRequestCode;var i=this.getView().getModel("viewModel");if(this.materialRequestCode===undefined){var r=window.location.href;var l=r.split("/");this.materialRequestCode=l[l.length-1]}const n=new s;this.getView().setModel(n,"materialRequestDetailModel");n.loadData(backendUrl+"materialRequest/getMaterialRequestById?code="+this.materialRequestCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});n.dataLoaded().then(function(){var e=this.getView().getModel("materialRequestDetailModel").getData();var t=new Array;e.METERIALREQLINESCollection.map(function(e){t.push(e.U_AccountCode)});var o=t.join();if(a.roleId==4){i.setProperty("/editable",false);i.setProperty("/is_approver",true);i.setProperty("/is_requestor",false);if(e.U_Status==3){i.setProperty("/showFooter",false)}}else if(a.roleId==5){i.setProperty("/editable",false);i.setProperty("/is_approver",true);i.setProperty("/is_requestor",false);if(e.U_Status==2){i.setProperty("/showFooter",false)}}else if(a.roleId==3){i.setProperty("/is_approver",false);i.setProperty("/is_requestor",true);if(e.U_Status!=1){i.setProperty("/showFooter",false);i.setProperty("/editable",false)}}let r=new s;this.getView().setModel(r,"budget");r.loadData(backendUrl+"budget/getBudgetById?code="+e.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=new s;l.loadData(backendUrl+"getBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(l,"budgeting");var n=this.getView().byId("materialReqLineTableID");var u=this.getView().getModel("items");u.setProperty("/data",[]);var d=u.getData();var g=new s;for(let t=0;t<e.METERIALREQLINESCollection.length;t++){let s=e.METERIALREQLINESCollection[t].U_AccountCode.toString();n.getRows()[t].getCells()[1].setBusy(true);if(!(s in d)){g.loadData(backendUrl+"items/getItemsByAccount?accountCode="+s,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});g.dataLoaded().then(function(){var e=g.getData();d.data[s]=e;var a=new sap.ui.model.json.JSONModel(d);this.getView().setModel(a,"items");a.refresh();n.getRows()[t].getCells()[1].setBusy(false)}.bind(this))}n.getRows()[t].getCells()[1].bindAggregation("items",{path:"items>/data/"+s,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})})}u.dataLoaded().then(function(){this.getView().byId("materialRequestPageID").setBusy(false)}.bind(this))}.bind(this))},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var a=this.getOwnerComponent().getRouter();a.navTo("dashboard",{},true)}},onApproveButtonClick:function(){var e=this.getView().byId("materialRequestPageID");var t=this.getView().getModel("viewModel");e.setBusy(true);var s=this.getView().byId("_IDGenText101").getText();const i=this.getView().getModel("materialRequestDetailModel");var l=i.getProperty("/");var g=this.getView();var c=this.oDialog;var h=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(l),headers:{Authorization:"Bearer "+h},crossDomain:true,url:backendUrl+"materialRequest/approveMR",contentType:"application/json",success:function(s,i,l){e.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new r({text:"Material Request approved"}),beginButton:new o({type:n.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});t.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onAddPress:function(e){const t=this.getView().getModel("materialRequestDetailModel");var s=t.getData();var a={U_AccountCode:"",U_ItemCode:"",U_Qty:""};s.METERIALREQLINESCollection.push(a);var o=new sap.ui.model.json.JSONModel(s);this.getView().setModel(o,"materialRequestDetailModel");o.refresh()},onDelete:function(e){var t=e.getParameters().row;var s=t.getIndex();var a=this.getView().getModel("materialRequestDetailModel");var o=a.getData().METERIALREQLINESCollection;o.splice(s,1);a.setProperty("/METERIALREQLINESCollection",o);a.refresh()},onSaveButtonClick:function(e){var t=this.getView().byId("materialRequestPageID");t.setBusy(true);var s=this.getView().getModel("materialRequestDetailModel");var i=JSON.stringify(s.getData());var l=this.oJWT;console.log(i);$.ajax({type:"POST",data:i,headers:{Authorization:"Bearer "+l},crossDomain:true,url:backendUrl+"materialRequest/saveMR",contentType:"application/json",success:function(e,s,i){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new r({text:"Material Request saved"}),beginButton:new o({type:n.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onBudgetChange:async function(e){var t=e.getSource(),s=t.getSelectedKey(),a=t.getValue();if(!s&&a){t.setValueState(d.Error);t.setValueStateText("Please enter a valid Budget Code")}else{t.setValueState(d.None)}if(t.getValueState()==d.None){this.getView().byId("materialRequestPageID").setBusy(true);var o=parseInt(e.getParameters("selectedItem").value);var i=this.getView().getModel("budget");await i.loadData(backendUrl+"budget/getBudgetById?code="+o,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});i.refresh();this.getView().byId("materialRequestPageID").setBusy(false)}},onAccountCodeChange:async function(e){var t=e.getSource().getSelectedKey();var a=e.getSource().getParent();a.getCells()[1].setSelectedKey("");a.getCells()[1].setBusy(true);a.getCells()[1].setEnabled(true);var o=this.getView().getModel("items");var i=o.getData();if(!(t in i)){var r=new s;await r.loadData(backendUrl+"items/getItemsByAccount?accountCode="+t+"",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=r.getData();i[t]=l;var n=new sap.ui.model.json.JSONModel(i);this.getView().setModel(n,"items");n.refresh()}a.getCells()[1].bindAggregation("items",{path:"items>/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});a.getCells()[1].setBusy(false)}})});