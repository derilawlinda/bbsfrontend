sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,s,a,r,o,i,n){"use strict";var l=o.ButtonType;var u=o.DialogType;var d=n.ValueState;return e.extend("frontend.bbs.controller.materialRequest.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("materialRequestDetail").attachPatternMatched(this._onObjectMatched,this);var t=new s(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(t,"companies")},_onObjectMatched:function(e){var t=new s;this.getView().setModel(t,"viewModel");this.getView().byId("materialRequestPageID").setBusy(true);var a=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=a.get("jwt");this.materialRequestCode=e.getParameter("arguments").materialRequestID;var r=this.getOwnerComponent().getModel("userModel");if(r===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.buildForm,this)}else{var o=r.getData();var i={userName:o.user.name,roleId:o.user.role_id,roleName:o.role[0].name,status:"success"};this.buildForm("username","checkToken",i)}},buildForm:function(e,t,a){if(a.status=="error"){alert("Error");this.getView().byId("materialRequestPageID").setBusy(false)}var r=this.materialRequestCode;var o=this.getView().getModel("viewModel");if(this.materialRequestCode===undefined){var i=window.location.href;var n=i.split("/");this.materialRequestCode=n[n.length-1]}const l=new s;this.getView().setModel(l,"materialRequestDetailModel");l.loadData(backendUrl+"materialRequest/getMaterialRequestById?code="+this.materialRequestCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});l.dataLoaded().then(function(){var e=this.getView().getModel("materialRequestDetailModel").getData();if(a.roleId==4){o.setProperty("/editable",false);o.setProperty("/is_approver",true);o.setProperty("/is_requestor",false);if(e.U_Status==3){o.setProperty("/showFooter",false)}}else if(a.roleId==5){o.setProperty("/editable",false);o.setProperty("/is_approver",true);o.setProperty("/is_requestor",false);if(e.U_Status==2){o.setProperty("/showFooter",false)}}else if(a.roleId==3){o.setProperty("/is_approver",false);o.setProperty("/is_requestor",true);if(e.U_Status!=1){o.setProperty("/showFooter",false);o.setProperty("/editable",false)}}const t=new s;this.getView().setModel(t,"budget");t.loadData(backendUrl+"budget/getBudgetById?code="+e.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var r=new s;r.loadData(backendUrl+"getBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(r,"budgeting");r.dataLoaded().then(function(){this.getView().byId("materialRequestPageID").setBusy(false)}.bind(this))}.bind(this))},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var a=this.getOwnerComponent().getRouter();a.navTo("dashboard",{},true)}},onApproveButtonClick:function(){var e=this.getView().byId("materialRequestPageID");var t=this.getView().getModel("viewModel");e.setBusy(true);var s=this.getView().byId("_IDGenText101").getText();const o=this.getView().getModel("materialRequestDetailModel");var n=o.getProperty("/");var g=this.getView();var c=this.oDialog;var h=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(n),headers:{Authorization:"Bearer "+h},crossDomain:true,url:backendUrl+"materialRequest/approveMR",contentType:"application/json",success:function(s,o,n){e.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new a({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Material Request approved"}),beginButton:new r({type:l.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});t.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})}})});