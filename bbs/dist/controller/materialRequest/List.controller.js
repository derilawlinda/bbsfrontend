sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/core/Fragment","sap/ui/layout/HorizontalLayout","sap/ui/layout/VerticalLayout","sap/m/Dialog","sap/m/Button","sap/m/Label","sap/m/library","sap/m/MessageToast","sap/m/Text","sap/m/TextArea","sap/ui/model/json/JSONModel","frontend/bbs/libs/lodash"],function(e,t,o,a,r,i,n,s,l,u,g,d,c){"use strict";var m=l.ButtonType;var p=l.DialogType;return e.extend("frontend.bbs.controller.materialRequest.List",{onInit:async function(){var e=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=e.get("jwt");var t=new c;t.loadData(backendUrl+"materialRequest/getMaterialRequests",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(t,"materialRequest");var o=new c(sap.ui.require.toUrl("frontend/bbs/model/sales_order.json"));this.getView().setModel(o,"salesOrder");var a=new c(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(a,"companies");var r=new sap.ui.model.json.JSONModel;this.getView().setModel(r,"materialRequestHeader");var i=new sap.ui.model.json.JSONModel({U_RemainingBudget:0});this.getView().setModel(i,"budgetHeader");var n=new c;n.loadData(backendUrl+"getBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(n,"budgeting");var s=new sap.ui.model.json.JSONModel;this.getView().setModel(s,"new_mr_items");this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[])},onCreateButtonClick:function(e){console.log(this.getView().getModel("budgeting"));if(!this.createMaterialRequestDialog){this.createMaterialRequestDialog=this.loadFragment({name:"frontend.bbs.view.materialRequest.CreateForm"})}this.createMaterialRequestDialog.then(function(e){var t=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(t,"createFragmentViewModel");t.setProperty("/Date",new Date);this.oDialog=e;this.oDialog.open();var o=new sap.ui.model.json.JSONModel;var a=[];o.setData(a);this.getView().setModel(o,"materialRequestgDetailModel");this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[])}.bind(this))},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},onNavBack:function(e){var o,a;o=t.getInstance();a=o.getPreviousHash();if(a!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_closeDialog:function(){this.oDialog.close()},onPress:function(e){var t=this.getOwnerComponent().getRouter();var o=e.getSource().getBindingContextPath();var a=o.split("/").slice(-1).pop();t.navTo("materialRequestDetail",{materialRequestID:a})},buttonFormatter:function(e){if(e==2){return"Accept"}else if(e==1){return"Attention"}else{return"Reject"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},onBudgetChange:function(e){var t=this.getView().getModel("budgeting");var o=t.getData().value;var a=parseInt(e.getParameters("selectedItem").value);let r=_.find(o,function(e){if(e.Code==a){return true}});var i=r.U_TotalAmount;var n=r.BUDGETUSEDCollection;let s=0;for(let e=0;e<n.length;e++){s+=n[e]["U_Amount"]}r.U_RemainingBudget=i-s;var l=this.getView().getModel("budgetHeader");l.setData(r)},onSaveButtonClick:function(e){const t=this.getView().getModel("materialRequestHeader");const o=this.getView().getModel("new_mr_items");var a=this.getView().getModel("materialRequest");t.setProperty("/METERIALREQLINESCollection",o.getData().MATERIALREQLINESCollection);var r=t.getProperty("/");var i=this.getView();var n=this.oDialog;var s=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(r),crossDomain:true,url:backendUrl+"materialRequest/createMaterialRequest",contentType:"application/json",success:function(e,t,o){n.close();a.loadData(backendUrl+"materialRequest/getMaterialRequests",null,true,"GET",false,false,{Authorization:"Bearer "+s});i.getModel("materialRequest").refresh()},error:function(e,t,o){console.log("Got an error response: "+t+o)}})},onAddPress:function(e){const t=this.getView().getModel("new_mr_items");var o=t.getData();var a={U_AccountCode:"",U_ItemCode:"",U_Qty:""};o.MATERIALREQLINESCollection.push(a);var r=new sap.ui.model.json.JSONModel(o);this.getView().setModel(r,"new_mr_items");r.refresh()}})});