sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/m/library","sap/m/MessageToast","frontend/bbs/model/PagingJSONModel","sap/ui/core/library","sap/ui/core/Fragment","sap/ui/Device","sap/m/Dialog","sap/m/Button","sap/m/MessageBox","frontend/bbs/libs/lodash","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,i,s,o,r,n,l,u,g,d,c){"use strict";var m=a.ButtonType;var h=a.DialogType;var f=o.ValueState;return e.extend("frontend.bbs.controller.materialRequest.List",{onInit:async function(){this.getView().byId("materialRequestTableID").setBusy(true);this._mViewSettingsDialogs={};var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");this.company=t.get("company");var a=new s;var i=new sap.ui.model.json.JSONModel;i.loadData(backendUrl+"main/getPillar",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var o=new sap.ui.model.json.JSONModel;i.dataLoaded().then(function(){var e=i.getData();o.setData(e)});this.getView().setModel(o,"companies");a.loadData(backendUrl+"materialRequest/getMaterialRequests",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(a,"materialRequest");a.dataLoaded().then(function(){this.getView().byId("materialRequestTableID").setBusy(false)}.bind(this));var r=new s;this.getView().setModel(r,"items");var n=new sap.ui.model.json.JSONModel({showCreateButton:true,is_approver:false});this.getView().setModel(n,"viewModel");var l=new sap.ui.model.json.JSONModel({U_RemainingBudget:0});this.getView().setModel(l,"budgetHeader");var u=new s;u.setSizeLimit(1e3);u.loadData(backendUrl+"budget/getApprovedBudget",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(u,"MRbudgets");var g=new sap.ui.model.json.JSONModel;this.getView().setModel(g,"new_mr_items");this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[]);var d=this.getOwnerComponent().getModel("userModel");if(d===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.toggleCreateButton,this)}else{var c=d.getData();var m={userName:c.user.name,roleId:c.user.role_id,roleName:c.role[0].name,status:"success"};this.toggleCreateButton("username","checkToken",m)}},onGrowingStarted:function(){},toggleCreateButton:function(e,t,a){if(a.roleId==4||a.roleId==5){this.getView().getModel("viewModel").setProperty("/showCreateButton",false);this.getView().getModel("viewModel").setProperty("/is_approver",true)}},onCreateButtonClick:function(e){if(!this.createMaterialRequestDialog){this.createMaterialRequestDialog=this.loadFragment({name:"frontend.bbs.view.materialRequest.CreateForm"})}this.createMaterialRequestDialog.then(function(e){let t=new sap.ui.model.json.JSONModel;this.getView().setModel(t,"budgetHeader");let a=new sap.ui.model.json.JSONModel;this.getView().setModel(a,"new_mr_items");let i=new sap.ui.model.json.JSONModel;this.getView().setModel(i,"materialRequestHeader");var s=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(s,"createFragmentViewModel");this.oDialog=e;this.oDialog.open();var o=new sap.ui.model.json.JSONModel;var r=[];o.setData(r);this.getView().setModel(o,"materialRequestgDetailModel");this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[])}.bind(this))},onAccountCodeChange:async function(e){var t=e.getSource().getSelectedKey();var a=e.getSource().getParent();this.selectedRow=a;a.getCells()[1].setBusy(true);a.getCells()[1].setSelectedKey("");a.getCells()[1].setEnabled(true);a.getCells()[1].setEnabled(true);var i=this.getView().getModel("items");i.setSizeLimit(1e4);var o=i.getData();if(!(t in o)){var r=new s;r.setSizeLimit(1e4);await r.loadData(backendUrl+"items/getItemsByAccount",{accountCode:t,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var n=r.getData();o[t]=n;var l=new sap.ui.model.json.JSONModel(o);l.setSizeLimit(1e4);this.getView().setModel(l,"items");l.refresh()}a.getCells()[1].setBusy(false)},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},onValueHelpRequest:function(e){var t=e.getSource().getValue(),a=this.getView();var i=e.getSource().getParent();this.selectedRow=i;var o=i.getCells()[0].getSelectedKey();var n=this.getView().getModel("items");var l=n.getData();var u=new s;u.setData(l[o]);this.getView().setModel(u,"oItemShow");if(!this._pValueHelpDialog){this._pValueHelpDialog=r.load({id:a.getId(),name:"frontend.bbs.view.materialRequest.ValueHelpDialog",controller:this}).then(function(e){a.addDependent(e);return e})}this._pValueHelpDialog.then(function(e){e.bindElement({model:"oItemShow",path:o});e.open(t)})},onValueHelpClose:function(e){var t=e.getParameter("selectedItem");this.oBindingInfo=e.getSource().getBindingInfo("items");if(this.oBindingInfo.filters){e.getSource().getBinding("items").filter(this.oBindingInfo.filters)}else{e.getSource().getBinding("items").filter([])}if(!t){return}this.selectedRow.getCells()[1].setValue(t.getTitle())},onValueHelpSearch:function(e){var t=e.getParameter("value");this.oBindingInfo=this.getView().byId("selectDialog").getBindingInfo("items");if(t){this.oBindingInfo.filters=[new sap.ui.model.Filter("ItemCode",sap.ui.model.FilterOperator.EQ,t)]}else{delete this.oBindingInfo.filters}this.getView().byId("selectDialog").bindAggregation("items",this.oBindingInfo)},onNavBack:function(e){var a,i;a=t.getInstance();i=a.getPreviousHash();if(i!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_closeDialog:function(){this.oDialog.close()},onPress:function(e){var t=this.getOwnerComponent().getRouter();var a=e.getSource();var i=a.getCells()[0].getText();var s=a.getBindingContext("materialRequest").getPath();this.getOwnerComponent().getModel("globalModel").setData({MRpath:s});t.navTo("materialRequestDetail",{materialRequestID:i})},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},onBudgetChange:async function(e){var t=e.getSource(),a=t.getSelectedKey(),i=t.getValue();if(!a&&i){t.setValueState(f.Error);t.setValueStateText("Please enter a valid Budget Code")}else{t.setValueState(f.None)}if(t.getValueState()==f.None){this.getView().byId("createMRForm").setBusy(true);this.getView().byId("MRItemsTableID").setBusy(true);this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[]);var o=parseInt(e.getParameters("selectedItem").value);var r=new s;await r.loadData(backendUrl+"budget/getBudgetById?",{code:o,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var n=new s;n.setSizeLimit(500);await n.loadData(backendUrl+"coa/getCOAsByBudget",{budgetCode:o,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(n,"accounts");var l=r.getData();var u=l.U_TotalAmount;var g=l.BUDGETUSEDCollection;let t=0;for(let e=0;e<g.length;e++){t+=g[e]["U_Amount"]}l.U_RemainingBudget=u-t;var d=this.getView().getModel("budgetHeader");d.setData(l);this.getView().byId("createMRForm").setBusy(false);this.getView().byId("MRItemsTableID").setBusy(false)}},onSaveButtonClick:function(e){var t=new Array;var a=this.oDialog;a.setBusy(true);const s=this.getView().getModel("materialRequestHeader");var o=this.getView().byId("companyText").getText();const r=this.getView().getModel("new_mr_items");var n=this.getView().getModel("materialRequest");s.setProperty("/MATERIALREQLINESCollection",r.getData().MATERIALREQLINESCollection);var l=s.getProperty("/");var u=this.getView();var d=this.oJWT;$.ajax({type:"POST",data:JSON.stringify({company:o,oProperty:l}),crossDomain:true,headers:{Authorization:"Bearer "+d},url:backendUrl+"materialRequest/createMaterialRequest",contentType:"application/json",success:function(e,t,s){a.setBusy(false);a.close();n.loadData(backendUrl+"materialRequest/getMaterialRequests",{company:o},true,"GET",false,false,{Authorization:"Bearer "+d});i.show("Material Request created");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});u.getModel("materialRequest").refresh()},error:function(e,t,i){a.setBusy(false);g.error(e.responseJSON.msg)}})},onAddPress:function(e){const t=this.getView().getModel("new_mr_items");var a=t.getData();var i={U_AccountCode:"",U_ItemCode:"",U_Qty:"",U_Description:""};a.MATERIALREQLINESCollection.push(i);var s=new sap.ui.model.json.JSONModel(a);this.getView().setModel(s,"new_mr_items");s.refresh()},onDelete:function(e){var t=e.getParameters().row;var a=t.getIndex();var i=this.getView().getModel("new_mr_items");var s=i.getData().MATERIALREQLINESCollection;s.splice(a,1);i.setProperty("/MATERIALREQLINESCollection",s);i.refresh()},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},dateFormatter:function(e){var t=new Date(e);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var i=a.format(t);return i},handleFilterButtonPressed:function(){this.getViewSettingsDialog("frontend.bbs.view.materialRequest.FilterForm").then(function(e){e.open()})},getViewSettingsDialog:function(e){var t=this._mViewSettingsDialogs[e];if(!t){t=r.load({id:this.getView().getId(),name:e,controller:this}).then(function(e){if(n.system.desktop){e.addStyleClass("sapUiSizeCompact")}return e});this._mViewSettingsDialogs[e]=t}return t},onSearch:function(e){var t=e.getParameters();if(t.filterKeys){var a=Object.keys(t.filterKeys).toString()}else{var a=""}this.getView().byId("materialRequestTableID").setBusy(true);var i=this.getView().byId("searchField").getValue();var o=this.oJWT;var r=new s;r.loadData(backendUrl+"materialRequest/getMaterialRequests",{search:i,status:a,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+o});r.dataLoaded().then(function(){this.getView().byId("materialRequestTableID").setBusy(false)}.bind(this));this.getView().setModel(r,"materialRequest")}})});