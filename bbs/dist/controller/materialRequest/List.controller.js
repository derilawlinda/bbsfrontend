sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/m/library","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/library","frontend/bbs/libs/lodash"],function(e,t,a,r,o,s){"use strict";var i=a.ButtonType;var n=a.DialogType;var l=s.ValueState;return e.extend("frontend.bbs.controller.materialRequest.List",{onInit:async function(){this.getView().byId("materialRequestTableID").setBusy(true);var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");var a=new o;a.loadData(backendUrl+"materialRequest/getMaterialRequests",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(a,"materialRequest");a.dataLoaded().then(function(){this.getView().byId("materialRequestTableID").setBusy(false)}.bind(this));var r=new o(sap.ui.require.toUrl("frontend/bbs/model/sales_order.json"));this.getView().setModel(r,"salesOrder");var s=new o(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(s,"companies");var i=new o(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(i,"items");var n=new sap.ui.model.json.JSONModel({showCreateButton:true});this.getView().setModel(n,"viewModel");var l=new sap.ui.model.json.JSONModel({U_RemainingBudget:0});this.getView().setModel(l,"budgetHeader");var u=new o;u.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(u,"budgeting");var d=new sap.ui.model.json.JSONModel;this.getView().setModel(d,"new_mr_items");this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[]);var g=this.getOwnerComponent().getModel("userModel");if(g===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.toggleCreateButton,this)}else{var c=g.getData();var m={userName:c.user.name,roleId:c.user.role_id,roleName:c.role[0].name,status:"success"};this.toggleCreateButton("username","checkToken",m)}},toggleCreateButton:function(e,t,a){console.log(a);if(a.roleId==4||a.roleId==5){this.getView().getModel("viewModel").setProperty("/showCreateButton",false)}},onCreateButtonClick:function(e){if(!this.createMaterialRequestDialog){this.createMaterialRequestDialog=this.loadFragment({name:"frontend.bbs.view.materialRequest.CreateForm"})}this.createMaterialRequestDialog.then(function(e){let t=new sap.ui.model.json.JSONModel;this.getView().setModel(t,"budgetHeader");let a=new sap.ui.model.json.JSONModel;this.getView().setModel(a,"new_mr_items");let r=new sap.ui.model.json.JSONModel;this.getView().setModel(r,"materialRequestHeader");var o=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(o,"createFragmentViewModel");this.oDialog=e;this.oDialog.open();var s=new sap.ui.model.json.JSONModel;var i=[];s.setData(i);this.getView().setModel(s,"materialRequestgDetailModel");this.getView().getModel("new_mr_items").setProperty("/METERIALREQLINESCollection",[])}.bind(this))},onAccountCodeChange:async function(e){var t=e.getSource().getSelectedKey();var a=e.getSource().getParent();a.getCells()[1].setBusy(true);a.getCells()[1].setSelectedKey("");a.getCells()[1].setEnabled(true);a.getCells()[1].setEnabled(true);var r=this.getView().getModel("items");var s=r.getData();if(!(t in s)){var i=new o;await i.loadData(backendUrl+"items/getItemsByAccount?accountCode="+t+"",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var n=i.getData();s[t]=n;var l=new sap.ui.model.json.JSONModel(s);this.getView().setModel(l,"items");l.refresh()}a.getCells()[1].bindAggregation("items",{path:"items>/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});a.getCells()[1].setBusy(false)},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},onNavBack:function(e){var a,r;a=t.getInstance();r=a.getPreviousHash();if(r!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_closeDialog:function(){this.oDialog.close()},onPress:function(e){var t=this.getOwnerComponent().getRouter();var a=e.getSource();var r=a.getCells()[0].getText();t.navTo("materialRequestDetail",{materialRequestID:r})},buttonFormatter:function(e){if(e==2){return"Accept"}else if(e==1){return"Attention"}else{return"Reject"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},onBudgetChange:async function(e){var t=e.getSource(),a=t.getSelectedKey(),r=t.getValue();if(!a&&r){t.setValueState(l.Error);t.setValueStateText("Please enter a valid Budget Code")}else{t.setValueState(l.None)}if(t.getValueState()==l.None){this.getView().byId("createMRForm").setBusy(true);this.getView().byId("MRItemsTableID").setBusy(true);this.getView().getModel("new_mr_items").setProperty("/MATERIALREQLINESCollection",[]);var s=parseInt(e.getParameters("selectedItem").value);var i=new o;await i.loadData(backendUrl+"budget/getBudgetById?code="+s,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var n=new o;await n.loadData(backendUrl+"coa/getCOAsByBudget?budgetCode="+s,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(n,"accounts");var u=i.getData();var d=u.U_TotalAmount;var g=u.BUDGETUSEDCollection;let t=0;for(let e=0;e<g.length;e++){t+=g[e]["U_Amount"]}u.U_RemainingBudget=d-t;var c=this.getView().getModel("budgetHeader");c.setData(u);this.getView().byId("createMRForm").setBusy(false);this.getView().byId("MRItemsTableID").setBusy(false)}},onSaveButtonClick:function(e){var t=new Array;var a=this.oDialog;a.setBusy(true);const o=this.getView().getModel("materialRequestHeader");const s=this.getView().getModel("new_mr_items");var i=this.getView().getModel("materialRequest");o.setProperty("/METERIALREQLINESCollection",s.getData().MATERIALREQLINESCollection);var n=o.getProperty("/");var l=this.getView();var u=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(n),crossDomain:true,headers:{Authorization:"Bearer "+u},url:backendUrl+"materialRequest/createMaterialRequest",contentType:"application/json",success:function(e,t,o){a.setBusy(false);a.close();i.loadData(backendUrl+"materialRequest/getMaterialRequests",null,true,"GET",false,false,{Authorization:"Bearer "+u});r.show("Material Request created");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});l.getModel("materialRequest").refresh()},error:function(e,t,a){console.log("Got an error response: "+t+a)}})},onAddPress:function(e){const t=this.getView().getModel("new_mr_items");var a=t.getData();var r={U_AccountCode:"",U_ItemCode:"",U_Qty:""};a.MATERIALREQLINESCollection.push(r);var o=new sap.ui.model.json.JSONModel(a);this.getView().setModel(o,"new_mr_items");o.refresh()},onDelete:function(e){var t=e.getParameters().row;var a=t.getIndex();var r=this.getView().getModel("new_mr_items");var o=r.getData().MATERIALREQLINESCollection;o.splice(a,1);r.setProperty("/METERIALREQLINESCollection",o);r.refresh()},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else{return"Rejected"}},dateFormatter:function(e){var t=new Date(e);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var r=a.format(t);return r}})});