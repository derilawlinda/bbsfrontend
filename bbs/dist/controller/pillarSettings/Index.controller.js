sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/FilterOperator","frontend/bbs/libs/lodash"],function(e,t,i,o,s,a){"use strict";var r=e.extend("frontend.bbs.controller.pillarSettings.Index",{_viewConfigData:{addButtonVisibility:false,removeButtonVisibility:false},onInit:function(e){this.getView().byId("Tree").setBusy(true);this.oSemanticPage=this.byId("_IDSemanticPage1");this.oEditAction=this.byId("editAction");var i=jQuery.sap.storage(jQuery.sap.storage.Type.local);var o=i.get("company");this.company=o;this.oJWT=i.get("jwt");var s=new t;s.setSizeLimit(1e3);s.loadData(backendUrl+"main/getPillar",{company:o},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});s.dataLoaded().then(function(){this.getView().byId("Tree").setBusy(false)}.bind(this));var a=new t(this._viewConfigData);this.getView().setModel(a,"viewConfig");s.attachRequestCompleted(null,function(){var e=s.getData();var t=this.flattenMyTree(e);var i=_.filter(t,{subheader:"Pillar"});var o=new sap.ui.model.json.JSONModel(i);this.getView().setModel(o,"pillarModel");this.getView().setModel(s)},this);this.oPillarModel=new t;this.oPillarModel.setSizeLimit(200);this.oPillarModel.loadData(backendUrl+"profitCenter/getPillars",{company:o},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.oClassificationModel=new t;this.oClassificationModel.setSizeLimit(200);this.oClassificationModel.loadData(backendUrl+"profitCenter/getClassifications",{company:o},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.oSubClassModel=new t;this.oSubClassModel.setSizeLimit(200);this.oSubClassModel.loadData(backendUrl+"profitCenter/getSubClass",{company:o},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.oSubClass2Model=new t;this.oSubClass2Model.setSizeLimit(200);this.oSubClass2Model.loadData(backendUrl+"profitCenter/getSubClass2",{company:o},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT})},flattenMyTree:function(e){function t(e){return _.flatMap(e,function(e){return _.concat([_.assign({subheader:e.subheader,text:e.text},_.omit(e,"nodes"))],t(e.nodes))})}return t(e)},onEdit:function(){this.showFooter(true);var e=this.getView().getModel("viewConfig");e.setProperty("/addButtonVisibility",true);e.setProperty("/removeButtonVisibility",true);this.oEditAction.setVisible(false)},showFooter:function(e){this.oSemanticPage.setShowFooter(e)},onSave:function(){var e=this.getView().byId("Tree");e.setBusy(true);this.showFooter(false);this.oEditAction.setVisible(true);var t=this.getView().getModel("viewConfig");t.setProperty("/addButtonVisibility",false);t.setProperty("/removeButtonVisibility",false);var o=this.getView().getModel();$.ajax({type:"POST",data:JSON.stringify({company:this.company,data:o.getData()}),crossDomain:true,headers:{Authorization:"Bearer "+this.oJWT},url:backendUrl+"main/saveJSONPillar",contentType:"application/json",success:function(t,o,s){e.setBusy(false);i.show("Pillar data saved");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"})},error:function(e,t,i){console.log("Got an error response: "+t+i)}})},onCancel:function(){this.showFooter(false);this.oEditAction.setVisible(true);var e=this.getView().getModel("viewConfig");e.setProperty("/addButtonVisibility",false);e.setProperty("/removeButtonVisibility",false)},addTile:function(e){var t=e.getSource().getParent().getParent().getParent();var i=t.getBindingContextPath();var o=this.getView().getModel();var s=o.getProperty(i);var a=this.getView().getModel("viewConfig");a.setProperty("/bindingPath",i);a.setProperty("/aData",s);var r;if(s.subheader=="Company"){r="Pillar";this.getView().setModel(this.oPillarModel,"nodes")}else if(s.subheader=="Pillar"){r="Classification";this.getView().setModel(this.oClassificationModel,"nodes")}else if(s.subheader=="Classification"){r="Subclass";this.getView().setModel(this.oSubClassModel,"nodes")}else if(s.subheader=="Subclass"){r="Subclass2";this.getView().setModel(this.oSubClass2Model,"nodes")}this.windowText=r;a.setProperty("/windowText",r);if(!this.createTileDialog){this.createTileDialog=this.loadFragment({name:"frontend.bbs.view.pillarSettings.addNode"})}this.createTileDialog.then(function(e){this.oDialog=e;this.oDialog.open()}.bind(this))},onAddNode:function(e){var t=this.getView().getModel();var i=this.getView().getModel("viewConfig");var o=i.getData();var s=o.aData;var a=o.bindingPath;var r=[];if(s.nodes!==undefined){r=s.nodes}else{s.nodes=r}var n=true;console.log(this.windowText);var l={text:this.getView().byId("nodeCombo").getValue(),subheader:this.windowText,is_editable:true,code:this.getView().byId("nodeCombo").getSelectedKey};r.push(l);t.setProperty(a,s);this.oDialog.close()},_closeDialog:function(){this.oDialog.close()},removeTile:function(e){var t=e.getSource().getParent().getParent().getParent();var i=t.getBindingContextPath();var o=this.getView().getModel();var s=o.getProperty(i);var a=o.getData();this._deleteRecord(a,s);o.setData(a)},_deleteRecord:function(e,t){if(e!==undefined){for(var i=0;i<e.length;i++){if(e[i]===t){e.splice(i,1);break}else{this._deleteRecord(e[i].nodes,t)}}}},handleButtonPress:function(e){i.show("Button pressed")}});return r});