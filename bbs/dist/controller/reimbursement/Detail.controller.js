sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,s,o,r,a,i,n){"use strict";var l=a.ButtonType;var u=a.DialogType;var d=n.ValueState;return e.extend("frontend.bbs.controller.reimbursement.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("reimbursementDetail").attachPatternMatched(this._onObjectMatched,this);var t=new s(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(t,"items")},_onObjectMatched:async function(e){var t=new sap.ui.model.json.JSONModel({showFooter:false,editable:false,resubmit:false,NPWP:[{Name:0},{Name:2.5},{Name:3}]});this.getView().setModel(t,"viewModel");this.getView().byId("reimbursementPageID").setBusy(true);var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=o.get("jwt");var r=new s;await r.loadData(backendUrl+"checkToken",null,true,"POST",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().bindElement({path:"/value/"+window.decodeURIComponent(e.getParameter("arguments").ID),model:"reimbursements"});var a=e.getParameter("arguments").ID;if(a===undefined){var i=window.location.href;var n=i.split("/");a=n[n.length-1]}const l=new s;this.getView().setModel(l,"reimbursementDetailModel");l.loadData(backendUrl+"reimbursement/getReimbursementById?code="+a,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});l.refresh();var u=new s;u.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(u,"budgeting");l.dataLoaded().then(function(){var e=r.getData();var o=this.getView().getModel("reimbursementDetailModel").getData();if(e.user.role_id==4){t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==2){t.setProperty("/showFooter",true)}}else if(e.user.role_id==5){t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==1){t.setProperty("/showFooter",true)}}else if(e.user.role_id==3){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",true);t.setProperty("/resubmit",false);if(o.U_Status==4){t.setProperty("/resubmit",true)}if(o.U_Status==4||o.U_Status==1){t.setProperty("/showFooter",true);t.setProperty("/editable",true)}}var a=new s;a.loadData(backendUrl+"coa/getCOAsByBudget?budgetCode="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(a,"accounts");const i=new s;i.loadData(backendUrl+"budget/getBudgetById?code="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(i,"budget");i.dataLoaded().then(function(){var e=i.getData();var t=e.U_TotalAmount;var s=e.BUDGETUSEDCollection;let o=0;for(let e=0;e<s.length;e++){o+=s[e]["U_Amount"]}e.U_RemainingBudget=t-o;var r=this.getView().getModel("budget");r.setData(e);this.getView().byId("reimbursementPageID").setBusy(false)}.bind(this));a.dataLoaded().then(function(){var e=this.getView().byId("reimbursementLineTableID");var t=this.getView().getModel("items");t.setProperty("/data/",[]);t.refresh();var r=new s;var a=o.REIMBURSEMENTLINESCollection;var i=this.oJWT;for(let s=0;s<a.length;s++){e.getRows()[s].getCells()[1].setBusy(true);var n=t.getData();let o=a[s].U_AccountCode.toString();if(!(a[s].U_AccountCode in n)){r.loadData(backendUrl+"items/getItemsByAccount?accountCode="+o,null,true,"GET",false,false,{Authorization:"Bearer "+i});r.dataLoaded().then(function(){var t=r.getData();var a=this.getView().getModel("items");a.setProperty("/data/"+o,t);a.refresh();e.getRows()[s].getCells()[1].bindAggregation("items",{path:"items>/data/"+o,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});e.getRows()[s].getCells()[1].setBusy(false)}.bind(this))}else{e.getRows()[s].getCells()[1].bindAggregation("items",{path:"items>/data/"+o,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});e.getRows()[s].getCells()[1].setBusy(false)}}}.bind(this))}.bind(this))},onApproveButtonClick:function(){var e=this.getView().byId("reimbursementPageID");var t=this.getView().getModel("viewModel");e.setBusy(true);const s=this.getView().getModel("reimbursementDetailModel");var a=s.getProperty("/");var n=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(a),headers:{Authorization:"Bearer "+n},crossDomain:true,url:backendUrl+"reimbursement/approveReimbursement",contentType:"application/json",success:function(s,a,n){e.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new o({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Reimbursement approved"}),beginButton:new r({type:l.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});t.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onSaveButtonClick:function(e){var t=this.getView().byId("reimbursementPageID");t.setBusy(true);var s=this.getView().getModel("reimbursementDetailModel");var a=JSON.stringify(s.getData());var n=this.oJWT;console.log(a);$.ajax({type:"POST",data:a,headers:{Authorization:"Bearer "+n},crossDomain:true,url:backendUrl+"reimbursement/saveReimbursement",contentType:"application/json",success:function(e,s,a){t.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new o({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Reimbursement saved"}),beginButton:new r({type:l.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})})}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var o=this.getOwnerComponent().getRouter();o.navTo("dashboard",{},true)}},onDelete:function(e){var t=e.getParameters().row;var s=t.getIndex();var o=this.getView().getModel("reimbursementDetailModel");var r=o.getData().REIMBURSEMENTLINESCollection;r.splice(s,1);o.setProperty("/REIMBURSEMENTLINESCollection",r);o.refresh();this.onAmountChange()},onAddPress:function(e){const t=this.getView().getModel("reimbursementDetailModel");var s=t.getData();var o={U_AccountCode:"",U_ItemCode:"",U_NPWP:"",U_Amount:0,U_Description:""};s.REIMBURSEMENTLINESCollection.push(o);var r=new sap.ui.model.json.JSONModel(s);this.getView().setModel(r,"reimbursementDetailModel");r.refresh()},onAmountChange:function(e){const t=this.getView().getModel("reimbursementDetailModel");var s=t.getData().REIMBURSEMENTLINESCollection;const o=this.getView().getModel("viewModel");var r=this.getView().getModel("budget").getData();let a=0;for(let e=0;e<s.length;e++){a+=Number(s[e]["U_Amount"])}const i=this.getView().getModel("reimbursementDetailModel");i.setProperty("/U_TotalAmount",a);var n=r.U_RemainingBudget;if(a>n){this.getView().byId("submitButton").setEnabled(false);o.setProperty("/amountExceeded","Advance Amount exceeded Budget!")}else{this.getView().byId("submitButton").setEnabled(true);o.setProperty("/amountExceeded","")}}})});