sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library"],function(e,t,s,o,a,r,i,n){"use strict";var l=r.ButtonType;var u=r.DialogType;var d=n.ValueState;return e.extend("frontend.bbs.controller.reimbursement.Detail",{onInit:async function(){var e=this.getOwnerComponent();this.oRouter=e.getRouter();this.oRouter.getRoute("reimbursementDetail").attachPatternMatched(this._onObjectMatched,this);var t=new s(sap.ui.require.toUrl("frontend/bbs/model/items.json"));this.getView().setModel(t,"items")},_onObjectMatched:async function(e){var t=new sap.ui.model.json.JSONModel({NPWP:[{Name:0},{Name:2.5},{Name:3}]});this.getView().setModel(t,"viewModel");this.getView().byId("reimbursementPageID").setBusy(true);var o=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=o.get("jwt");var a=new s;await a.loadData(backendUrl+"checkToken",null,true,"POST",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().bindElement({path:"/value/"+window.decodeURIComponent(e.getParameter("arguments").ID),model:"reimbursements"});var r=e.getParameter("arguments").ID;if(r===undefined){var i=window.location.href;var n=i.split("/");r=n[n.length-1]}const l=new s;l.loadData(backendUrl+"reimbursement/getReimbursementById?code="+r,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(l,"reimbursementDetailModel");var u=new s;u.loadData(backendUrl+"budget/getApprovedBudget",null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(u,"budgeting");l.dataLoaded().then(function(){var e=a.getData();var o=this.getView().getModel("reimbursementDetailModel").getData();if(e.user.role_id==4){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==3){t.setProperty("/showFooter",false)}}else if(e.user.role_id==5){t.setProperty("/editable",false);t.setProperty("/is_approver",true);t.setProperty("/is_requestor",false);if(o.U_Status==2){t.setProperty("/showFooter",false)}}else if(e.user.role_id==3){t.setProperty("/is_approver",false);t.setProperty("/is_requestor",true);if(o.U_Status!=1){t.setProperty("/showFooter",false);t.setProperty("/editable",false)}}var r=new s;r.loadData(backendUrl+"coa/getCOAsByBudget?budgetCode="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(r,"accounts");const i=new s;i.loadData(backendUrl+"budget/getBudgetById?code="+o.U_BudgetCode,null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(i,"budget");i.dataLoaded().then(function(){var e=i.getData();var t=e.U_TotalAmount;var s=e.BUDGETUSEDCollection;let o=0;for(let e=0;e<s.length;e++){o+=s[e]["U_Amount"]}e.U_RemainingBudget=t-o;var a=this.getView().getModel("budget");a.setData(e);this.getView().byId("reimbursementPageID").setBusy(false)}.bind(this));var n=this.getView().getModel("items");n.setProperty("/data",[]);var l=n.getData();var u=new s;var d=[];for(let e=0;e<o.REIMBURSEMENTLINESCollection.length;e++){if(!(o.REIMBURSEMENTLINESCollection[e].U_AccountCode.toString()in d)){d.push(o.REIMBURSEMENTLINESCollection[e].U_AccountCode)}}var g=[...new Set(d)];for(let e=0;e<g.length;e++){this.getView().byId("reimbursementPageID").setBusy(true);u.loadData(backendUrl+"items/getItemsByAccount?accountCode="+g[e],null,true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});u.dataLoaded().then(function(){var t=u.getData();l.data[g[e]]=t;var s=new sap.ui.model.json.JSONModel(l);this.getView().setModel(s,"items");s.refresh();this.getView().byId("reimbursementPageID").setBusy(false)}.bind(this))}var c=this.getView().byId("reimbursementLineTableID");for(let e=0;e<o.REIMBURSEMENTLINESCollection.length;e++){c.getRows()[e].getCells()[1].setBusy(true);let t=o.REIMBURSEMENTLINESCollection[e].U_AccountCode.toString();c.getRows()[e].getCells()[1].bindAggregation("items",{path:"items>/data/"+t,template:new sap.ui.core.Item({key:"{items>ItemCode}",text:"{items>ItemCode} - {items>ItemName}"})});c.getRows()[e].getCells()[1].setBusy(false)}}.bind(this))},onApproveButtonClick:function(){var e=this.getView().byId("reimbursementPageID");var t=this.getView().getModel("viewModel");e.setBusy(true);const s=this.getView().getModel("reimbursementDetailModel");var r=s.getProperty("/");var n=this.oJWT;$.ajax({type:"POST",data:JSON.stringify(r),headers:{Authorization:"Bearer "+n},crossDomain:true,url:backendUrl+"reimbursement/approveReimbursement",contentType:"application/json",success:function(s,r,n){e.setBusy(false);if(!this.oSuccessMessageDialog){this.oSuccessMessageDialog=new o({type:u.Message,title:"Success",state:d.Success,content:new i({text:"Reimbursement approved"}),beginButton:new a({type:l.Emphasized,text:"OK",press:function(){this.oSuccessMessageDialog.close()}.bind(this)})});t.setProperty("/showFooter",false)}this.oSuccessMessageDialog.open()},error:function(e,t,s){console.log("Got an error response: "+t+s)}})},onNavBack:function(){var e=t.getInstance();var s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{var o=this.getOwnerComponent().getRouter();o.navTo("dashboard",{},true)}}})});