sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/library","sap/m/MessageToast","sap/ui/core/Fragment","sap/ui/Device","sap/m/MessageBox"],function(e,t,r,s,o,a,i,n,l,u,g,d){"use strict";var m=a.ButtonType;var c=a.DialogType;var h=n.ValueState;return e.extend("frontend.bbs.controller.reimbursement.List",{onInit:async function(){this.getView().byId("reimbursementTableID").setBusy(true);var e=this.getRouter().getHashChanger().getHash();var t=jQuery.sap.storage(jQuery.sap.storage.Type.local);this.oJWT=t.get("jwt");this.company=t.get("company");var s=new r;this._mViewSettingsDialogs={};s.setSizeLimit(500);s.loadData(backendUrl+"reimbursement/getReimbursements",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getOwnerComponent().setModel(s,"reimbursements");s.dataLoaded().then(function(){this.getView().byId("reimbursementTableID").setBusy(false)}.bind(this));var o=new r(sap.ui.require.toUrl("frontend/bbs/model/companies.json"));this.getView().setModel(o,"companies");var a=new r;this.getView().setModel(a,"items");this.getView().getModel("items").setProperty("/data",[]);var i=new sap.ui.model.json.JSONModel({showCreateButton:true,is_approver:false,NPWP:[{Name:0},{Name:2.5},{Name:3}]});this.getView().setModel(i,"viewModel");var n=new sap.ui.model.json.JSONModel({U_RemainingBudget:0});this.getView().setModel(n,"budgetHeader");var l=new r;l.setSizeLimit(500);l.loadData(backendUrl+"budget/getApprovedBudget",{company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(l,"budgeting");var u=new sap.ui.model.json.JSONModel;this.getView().setModel(u,"new_re_items");this.getView().getModel("new_re_items").setProperty("/REIMBURSEMENTLINESCollection",[]);var g=this.getOwnerComponent().getModel("userModel");if(g===undefined){const e=this.getOwnerComponent().getEventBus();e.subscribe("username","checktoken",this.toggleCreateButton,this)}else{var d=g.getData();var m={userName:d.user.name,roleId:d.user.role_id,roleName:d.role[0].name,status:"success"};this.toggleCreateButton("username","checkToken",m)}},toggleCreateButton:function(e,t,r){if(r.roleId==4||r.roleId==5||r.roleId==2){this.getView().getModel("viewModel").setProperty("/showCreateButton",false);this.getView().getModel("viewModel").setProperty("/is_approver",true)}},onAmountChange:function(e){const t=this.getView().getModel("new_re_items");var r=t.getData().REIMBURSEMENTLINESCollection;const s=this.getView().getModel("createFragmentViewModel");const o=this.getView().getModel("reimbursementHeader");var a=this.getView().getModel("budgetHeader").getData();let i=0;for(let e=0;e<r.length;e++){i+=r[e]["U_Amount"]}o.setProperty("/U_TotalAmount",i);var n=a.U_RemainingBudget;if(i>n){s.setProperty("/is_amountExceeded",true);s.setProperty("/createButtonEnabled",false);s.setProperty("/amountExceeded","Advance Amount exceeded Budget!")}else{s.setProperty("/is_amountExceeded",false);s.setProperty("/createButtonEnabled",true);s.setProperty("/amountExceeded","")}},search:function(e,t){if(t!=endTerm){matches=[]}if(!Array.isArray(e))return matches;var r=this;e.forEach(function(e){if(e.subheader===t){const r=e.nodes&&Array.isArray(e.nodes)?e.nodes.filter(e=>e.value===t):[];matches.push(e)}else{r.search(e.nodes,t)}endTerm=t});return matches},onCreateButtonClick:function(e){if(!this.createBudgetingDialog){this.createBudgetingDialog=this.loadFragment({name:"frontend.bbs.view.reimbursement.CreateForm"})}this.createBudgetingDialog.then(function(e){var t=new sap.ui.model.json.JSONModel({Date:new Date});this.getView().setModel(t,"createFragmentViewModel");var r=this.getView().getModel("budgetHeader");r.setData([]);var s=new sap.ui.model.json.JSONModel;this.getView().setModel(s,"reimbursementHeader");var o=new sap.ui.model.json.JSONModel;this.getView().setModel(o,"new_re_items");this.getView().getModel("new_re_items").setProperty("/REIMBURSEMENTLINESCollection",[]);this.oDialog=e;this.oDialog.open()}.bind(this))},onBudgetChange:async function(e){var t=e.getSource(),s=t.getSelectedKey(),o=t.getValue();if(!s&&o){t.setValueState(h.Error);t.setValueStateText("Please enter a valid Budget Code")}else{t.setValueState(h.None)}if(t.getValueState()==h.None){this.getView().byId("createReimbursementForm").setBusy(true);this.getView().byId("ReimbursementItemsTableID").setBusy(true);this.getView().getModel("new_re_items").setProperty("/REIMBURSEMENTLINESCollection",[]);var a=parseInt(e.getParameters("selectedItem").value);var i=new r;await i.loadData(backendUrl+"coa/getCOAsByBudget",{budgetCode:a,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});this.getView().setModel(i,"accounts");var n=new r;await n.loadData(backendUrl+"budget/getBudgetById",{code:a,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+this.oJWT});var l=n.getData();var u=l.U_TotalAmount;var g=l.BUDGETUSEDCollection;let t=0;for(let e=0;e<g.length;e++){t+=g[e]["U_Amount"]}l.U_RemainingBudget=u-t;var d=this.getView().getModel("budgetHeader");d.setData(l);this.getView().byId("createReimbursementForm").setBusy(false);this.getView().byId("ReimbursementItemsTableID").setBusy(false)}},onSaveButtonClick:function(e){var t=this.oDialog;t.setBusy(true);var r=this.getView().getModel("reimbursements");const s=this.getView().getModel("reimbursementHeader");const o=this.getView().getModel("new_re_items");s.setProperty("/REIMBURSEMENTLINESCollection",o.getData().REIMBURSEMENTLINESCollection);var a=s.getProperty("/");var i=this.getView();var n=this.oJWT;var u=this.company;$.ajax({type:"POST",data:JSON.stringify({oProperty:a,company:this.company}),crossDomain:true,headers:{Authorization:"Bearer "+n},url:backendUrl+"reimbursement/createReimbursement",contentType:"application/json",success:function(e,s,o){t.setBusy(false);t.close();r.loadData(backendUrl+"reimbursement/getReimbursements",{company:u},true,"GET",false,false,{Authorization:"Bearer "+n});l.show("Reimbursement Request created");$(".sapMMessageToast").css({"background-color":"#256f3a",color:"white"});i.getModel("reimbursements").refresh()},error:function(e,r,s){t.setBusy(false);d.error(e.responseJSON.msg)}})},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_closeDialog:function(){this.oDialog.close()},buttonFormatter:function(e){if(e==2||e==3||e==4){return"Accept"}else if(e==1){return"Attention"}else{return"Reject"}},onNavBack:function(e){var r,s;r=t.getInstance();s=r.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{this.getRouter().navTo("login",{},true)}},onPress:function(e){var t=this.getOwnerComponent().getRouter();var r=e.getSource();var s=r.getCells()[0].getText();var o=r.getBindingContext("reimbursements").getPath();this.getOwnerComponent().getModel("globalModel").setData({ReimbursementPath:o});t.navTo("reimbursementDetail",{ID:s})},onAddPress:function(e){const t=this.getView().getModel("new_re_items");var r=t.getData();var s={U_AccountCode:"",U_ItemCode:"",U_NPWP:"",U_Amount:0,U_Description:""};r.REIMBURSEMENTLINESCollection.push(s);var o=new sap.ui.model.json.JSONModel(r);this.getView().setModel(o,"new_re_items");o.refresh()},onSearch:function(e){var t=e.getParameters();if(t.filterKeys){var s=Object.keys(t.filterKeys).toString()}else{var s=""}this.getView().byId("reimbursementTable").setBusy(true);var o=this.getView().byId("searchField").getValue();var a=this.oJWT;var i=new r;i.loadData(backendUrl+"reimbursement/getReimbursements",{search:o,status:s,company:this.company},true,"GET",false,false,{Authorization:"Bearer "+a});i.dataLoaded().then(function(){this.getView().byId("reimbursementTable").setBusy(false)}.bind(this));this.getView().setModel(i,"reimbursements")},handleFilterButtonPressed:function(){this.getViewSettingsDialog("frontend.bbs.view.reimbursement.FilterForm").then(function(e){e.open()})},getViewSettingsDialog:function(e){var t=this._mViewSettingsDialogs[e];if(!t){t=u.load({id:this.getView().getId(),name:e,controller:this}).then(function(e){if(g.system.desktop){e.addStyleClass("sapUiSizeCompact")}return e});this._mViewSettingsDialogs[e]=t}return t},onDelete:function(e){var t=e.getParameters().row;var r=t.getIndex();var s=this.getView().getModel("new_re_items");var o=s.getData().REIMBURSEMENTLINESCollection;o.splice(r,1);s.setProperty("/REIMBURSEMENTLINESCollection",o);s.refresh();this.onAmountChange()},dateFormatter:function(e){if(e){var t=new Date(e);var r=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var s=r.format(t)}else{var s="-"}return s},objectFormatter:function(e){if(e==1){return"Warning"}else if(e==2){return"Information"}else if(e==3){return"Success"}else if(e==5){return"Information"}else{return"Error"}},textFormatter:function(e){if(e==1){return"Pending"}else if(e==2){return"Approved by Manager"}else if(e==3){return"Approved by Director"}else if(e==5){return"Transferred"}else{return"Rejected"}},onSelectionChange:function(e){console.log(e.getParameters("selected"))}})});